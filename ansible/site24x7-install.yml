---
# must pass target var e.g. ansible-playbook site24x7-install.yml -i inventories/ala-infrastructure-inventory -u ubuntu --private-key=~/.ssh/ala-ubuntu-key --extra-vars 'target=bla-bla'
- name: Install Site24x7 server monitoring agent
  hosts: image-service
  become: yes

  vars:
    device_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35623163636161333830363431616134613539383634333466613666366138323530646363323938
      3365316261376437616364316638373930626666383462650a633034303134343461633238363633
      39663838383337353735623562643639373466363630343434323539366432373062336135363265
      3338313761643439360a656364356538623466383639383061643538653437373232643038666332
      34306636346362336538396230366661313264633535313833663466643332303330616334376132
      6464383062323231393836396233396537623733356666386337

    proxy: NONE ##Change this value to required proxy setting like user:password@proxyhost:proxyport

  pre_tasks:
    - name: Check linux server monitoring agent exists
      stat:
        path: /opt/site24x7/monagent
      register: installed
    - name: Download 64 bit Site24x7 agent from public URL
      get_url:
        url: https://staticdownloads.site24x7.com/server/Site24x7_Linux_64bit.install
        dest: /opt/Site24x7_Linux_64bit.install
        mode: 0750
      when: ansible_machine == "x86_64" and not installed.stat.exists
    - name: Install 64 bit Site24x7 agent in the server
      shell: /opt/Site24x7_Linux_64bit.install -i -key={{ device_key }} -installer=ansible
      when: (ansible_machine == "x86_64" and proxy == "NONE" and not installed.stat.exists)
    - name: Install 64 bit Site24x7 agent in the server
      shell: /opt/Site24x7_Linux_64bit.install -i -key={{ device_key }} -installer=ansible -proxy={{ proxy }}
      when: (ansible_machine == "x86_64" and proxy != "NONE" and not installed.stat.exists)
    - service: name=site24x7monagent state=restarted
      when: ansible_machine == "x86_64" and not installed.stat.exists
    - name: Download 32 bit Site24x7 agent from public URL
      get_url:
        url: https://staticdownloads.site24x7.com/server/Site24x7_Linux_32bit.install
        dest: /opt/Site24x7_Linux_64bit.install
        mode: 0750
      when: ansible_machine == "i386" and not installed.stat.exists
    - name: Install 32 bit Site24x7 agent in the server
      shell: /opt/Site24x7_Linux_32bit.install -i -key={{ device_key }} -installer=ansible
      when: (ansible_machine == "i386" and proxy == "NONE" and not installed.stat.exists)
    - name: Install 32 bit Site24x7 agent in the server
      shell: /opt/Site24x7_Linux_32bit.install -i -key={{ device_key }} -installer=ansible -proxy={{ proxy }}
      when: (ansible_machine == "i386" and proxy != "NONE" and not installed.stat.exists)
    - service: name=site24x7monagent state=restarted
      when: ansible_machine == "i386" and not installed.stat.exists
    - name: Deleting 64 bit install file
      file:
        state: absent
        path: /opt/Site24x7_Linux_64bit.install
      when: ansible_machine == "x86_64" and not installed.stat.exists
    - name: Deleting 32 bit install file
      file:
        state: absent
        path: /opt/Site24x7_Linux_32bit.install
      when: ansible_machine == "i386"

  roles:
    - site24x7
