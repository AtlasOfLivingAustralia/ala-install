- name: create cas DB
  mysql_db: name=cas state=present

- name: create cas DB user
  mysql_user: name=cas password=password priv=*.*:ALL state=present
  
- name: copy transient files to tmp (schemas etc)
  copy: src={{item}} dest=/tmp
  with_items:
    - sp_get_user_attributes.sql
  tags:
    - createdb

- name: ensure mysql is running (this is idempotent so safe)
  service: name={{mysql_service}} state=started
  tags:
    - mysql

- name: create or recreate cas DB (existing data is lost) 
  shell: "{{item}}"
  with_items:
    - "mysql -u root -e 'DROP DATABASE IF EXISTS cas'"
    - "mysql -u root -e 'CREATE DATABASE cas'"
    - "mysql -u root cas < /tmp/sp_get_user_attributes.sql"
  tags:
    - createdb
  