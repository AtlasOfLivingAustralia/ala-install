# Steps up pipelines jenkins jobs and setups SSH between nodes for the jenkins user
# to enable master/slave setup through the Jenkins admin UI
#

- include: ../../common/tasks/setfacts.yml
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_jobs

- name: Set is_master
  set_fact:
    is_master: true
    is_slave: false
  when: ( 'jenkins_master' in groups and inventory_hostname in groups['jenkins_master'])
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_jobs

- name: Set is_slave
  set_fact:
    is_master: false
    is_slave: true
  when: ( 'jenkins_slaves' in groups and inventory_hostname in groups['jenkins_slaves'])
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_jobs

- name: Jenkins and Spark
  copy: src=100-jenkins-spark dest=/etc/sudoers.d/100-jenkins-spark
  tags:
    - pipelines_jenkins

- name: Creates environment.d directory
  file:
    path: /etc/environment.d/
    state: directory
  tags:
    - pipelines_jenkins

- name: HDFS and Spark tools
  copy: src=pipelines.conf dest=/etc/environment.d/pipelines.conf force=yes
  tags:
    - pipelines_jenkins

- name: Ensures {{project_root}}/conf dir exists
  file: path="/var/lib/jenkins/jobs/{{ item }}" state=directory owner=jenkins group=jenkins
  with_items:
    - Assertions-sync
    - Clear-file-locks
    - Clear-temp-directories
    - Clustering
    - Copy-dwca-to-hdfs
    - Dwc-verbatim-all
    - Dwc-verbatim-dataset
    - Full-indexed-to-solr
    - Image-load
    - Image-load-all
    - Image-sync
    - Image-sync-all
    - Index-all
    - Index-dataset
    - Ingest-dataset
    - Interpret-all
    - Interpret-dataset
    - Interpret-dataset-diag
    - Interpret-small-datasets
    - Jackknife-all
    - Refresh-vocabularies
    - Restart-docker-services
    - Restart-spark
    - SDS-all
    - SDS-dataset
    - SDS-small-datasets
    - Sample-dataset
    - Solr
    - Solr-pipeline
    - Solr-schema
    - UUID-all
    - UUID-dataset
    - Update-collection-alias
    - Validation-report
  when: is_master
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_jobs

- name: Jenkins jobs definitions
  template:
    src: "templates/{{ item }}"
    dest: "/var/lib/jenkins/jobs/{{ item }}"
    owner: jenkins
    group: jenkins
    mode: '0644'
    force: yes
  with_items:
    - Assertions-sync/config.xml
    - Clear-file-locks/config.xml
    - Clear-temp-directories/config.xml
    - Clustering/config.xml
    - Copy-dwca-to-hdfs/config.xml
    - Dwc-verbatim-all/config.xml
    - Dwc-verbatim-dataset/config.xml
    - Full-indexed-to-solr/config.xml
    - Image-load/config.xml
    - Image-load-all/config.xml
    - Image-sync/config.xml
    - Image-sync-all/config.xml
    - Index-all/config.xml
    - Index-dataset/config.xml
    - Ingest-dataset/config.xml
    - Interpret-all/config.xml
    - Interpret-dataset/config.xml
    - Interpret-dataset-diag/config.xml
    - Interpret-small-datasets/config.xml
    - Jackknife-all/config.xml
    - Refresh-vocabularies/config.xml
    - Restart-docker-services/config.xml
    - Restart-spark/config.xml
    - SDS-all/config.xml
    - SDS-dataset/config.xml
    - SDS-small-datasets/config.xml
    - Sample-dataset/config.xml
    - Solr/config.xml
    - Solr-pipeline/config.xml
    - Solr-schema/config.xml
    - UUID-all/config.xml
    - UUID-dataset/config.xml
    - Update-collection-alias/config.xml
    - Validation-report/config.xml
  when: is_master
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_jobs

- name: Create jenkins user on slaves
  user:
    name: "jenkins"
    system: yes
    shell: "/bin/bash"
    generate_ssh_key: yes
    state: present
  when: is_slave
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: adding existing jenkins user to group sudo
  user:
    name: 'jenkins'
    groups: sudo
    append: yes
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_user

- name: adding existing jenkins user to group sudo
  user:
    name: 'jenkins'
    groups: docker
    append: yes
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_user

- name: Upload SSH Key for master - mkdir
  file:
    path: /var/lib/jenkins/.ssh/
    state: directory
    owner: "jenkins"
    group: "jenkins"
    mode: 0600
  become: yes
  become_user: "jenkins"
  when: is_master
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: Upload SSH Key for master
  copy:
    src: "{{ ssh_key_filename }}"
    dest: "/var/lib/jenkins/.ssh/id_rsa"
    owner: "jenkins"
    group: "jenkins"
    mode: 0600
  become: yes
  become_user: "jenkins"
  when: is_master
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: Upload SSH Key for slave
  copy:
    src: "{{ ssh_key_filename }}"
    dest: "/home/jenkins/.ssh/id_rsa"
    owner: "jenkins"
    group: "jenkins"
    mode: 0600
  become: yes
  become_user: "jenkins"
  when: is_slave
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: Upload SSH Public Key for Jenkins user - mkdir
  file:
    path: /home/jenkins/.ssh/
    state: directory
    owner: "jenkins"
    group: "jenkins"
    mode: 0600
  become: yes
  become_user: "jenkins"
  when: is_slave
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: Upload SSH Public Key for Jenkins user - master
  copy:
    src: "{{ ssh_key_filename + '.pub' }}"
    dest: "/var/lib/jenkins/.ssh/id_rsa.pub"
    owner: "jenkins"
    group: "jenkins"
    mode: 0600
  when: is_master
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: Upload SSH Public Key for Jenkins user - slave
  copy:
    src: "{{ ssh_key_filename + '.pub' }}"
    dest: "/home/jenkins/.ssh/id_rsa.pub"
    owner: "jenkins"
    group: "jenkins"
    mode: 0600
  when: is_slave
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: Add ssh key to authorized keys
  authorized_key:
    user: "jenkins"
    state: present
    key: "{{ lookup('file', ssh_key_filename + '.pub') }}"
  become: yes
  become_user: "jenkins"
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: Add host keys slave
  shell: "ssh-keyscan {{ item }},`dig +short {{ item }}` >> /home/jenkins/.ssh/known_hosts"
  become: yes
  become_user: "jenkins"
  with_items: "{{ default_hosts }}"
  when: is_slave
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: Add host keys master
  shell: "ssh-keyscan {{ item }},`dig +short {{ item }}` >> /var/lib/jenkins/.ssh/known_hosts"
  become: yes
  become_user: "jenkins"
  with_items: "{{ default_hosts }}"
  when: is_master
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: create jenkins working directories
  file: path={{ item }} state=directory owner=jenkins group=jenkins recurse=true
  with_items:
    - "{{ data_dir }}/jenkins"
  when: is_slave
  tags:
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: Install python-setuptools
  apt: update_cache=yes name=python-setuptools
  tags:
    - python-pip
    - validation_report
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- name: Install pip
  apt: update_cache=yes name=python3-pip
  tags:
    - python-pip
    - validation_report
    - pipelines_jenkins
    - pipelines_jenkins_slaves

- pip:
    executable: pip3
    name: csvtotable
  tags:
    - validation_report
    - pipelines_jenkins
    - pipelines_jenkins_slaves
