--- 
# install the Java APM monitor
- block:
    - name: Download Java APM monitor
      get_url:
        url: https://dtdg.co/latest-java-tracer
        dest: "/opt/atlas/image-service/dd-java-agent.jar"
        mode: 0755

    - name: Install the Java agent
      lineinfile:
        path: /opt/atlas/image-service/image-service.conf
        regexp: '^JAVA_OPTS=".*/dd-java-agent.jar.*'
        line: 'JAVA_OPTS="${JAVA_OPTS} -javaagent:/opt/atlas/image-service/dd-java-agent.jar -Ddd.version={{ image_service_version }} -Ddd.service=image-service -Ddd.env=testing -Ddd.logs.injection=true -Ddd.profiling.enabled=true"'

   # - name: Restart the service
   #   systemd:
   #     name: image-service
   #     state: restarted

  when: datadog_java_apm_enabled|default(False)|bool
