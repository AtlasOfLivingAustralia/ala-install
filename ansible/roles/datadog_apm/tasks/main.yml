--- 
# install the Java APM tracer
- block:
    - name: Download Java APM tracer
      get_url:
        url: https://dtdg.co/latest-java-tracer
        dest: "{{ service_jar_dir }}dd-java-agent.jar"
        mode: 0755

    - name: Inject tracer and params into the JVM options
      lineinfile:
        path: /opt/atlas/image-service/image-service.conf
        regexp: '^JAVA_OPTS=".*/dd-java-agent.jar.*'
        line: 'JAVA_OPTS="${JAVA_OPTS} -javaagent:{{ service_jar_dir }}dd-java-agent.jar -Ddd.version={{ service_version }} -Ddd.service={{ service_name }} -Ddd.env={{ environment }} -Ddd.logs.injection=true -Ddd.profiling.enabled=true"'

    - name: Restart the service
      systemd:
        name: "{{ service_name }}"
        state: restarted

  when: datadog_java_apm_enabled|default(False)|bool
