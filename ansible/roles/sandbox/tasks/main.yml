- name: setup sandbox
  include: ../../common/tasks/setfacts.yml
  tags:
    - sandbox

#
# WAR file deployment and virtual host configuration
#

- name: setup apache for sandbox
  include: ../../apache_vhost/tasks/main.yml context_path='{{ sandbox_context_path }}' hostname='{{ sandbox_hostname }}' additional_proxy_pass='{{ additional_proxy_pass_values }}'
  tags:
    - sandbox
    - deploy
    - apache_vhost
  when: not webserver_nginx

- name: add nginx vhost if configured
  include_role:
    name: nginx_vhost
  vars:
    hostname: "{{ sandbox_hostname }}"
    context_path: "{{ sandbox_context_path }}"
  tags:
    - nginx_vhost
    - deploy
    - sandbox
  when: webserver_nginx

- debug: msg="Testing sandbox war url - {{ sandbox_war_url }} , path - {{ sandbox_context_path }} "
  tags:
     - sandbox

- name: setup tomcat for sandbox
  include: ../../tomcat_deploy/tasks/main.yml war_url='{{ sandbox_war_url }}' context_path='{{ sandbox_context_path }}' hostname='{{ sandbox_hostname }}'
  tags:
    - sandbox
    - deploy
    - tomcat_vhost

- name: ensure target apache directories exist
  file: path={{item}} state=directory
  with_items:
    - "/srv/{{ sandbox_hostname }}/www/"
  tags:
    - sandbox
    - deploy
    - apache_vhost

- name: Redirect to datacheck 
  template: src=index.html dest=/srv/{{ sandbox_hostname }}/www/index.html owner={{tomcat_user}} group={{tomcat_user}}
  tags:
    - sandbox
    - deploy
    - apache_vhost

#
# Properties and data file configuration
#

- name: ensure data directory exists
  file: path={{data_dir}}/sandbox/config state=directory owner={{tomcat_user}} group={{tomcat_user}}
  notify: 
    - restart tomcat
  tags:
    - sandbox
    - properties

- name: copy all template configs
  template: src=config/sandbox-config.properties dest={{data_dir}}/sandbox/config/sandbox-config.properties
  notify: 
    - restart tomcat
  tags:
    - sandbox
    - properties

- name: set data ownership [all data is owned by tomcat]
  file: path={{data_dir}}/sandbox owner={{tomcat_user}} group={{tomcat_user}} recurse=true
  notify: 
    - restart tomcat
  tags:
    - sandbox
    - properties
