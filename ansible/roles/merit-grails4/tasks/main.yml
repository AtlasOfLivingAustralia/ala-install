- include_tasks: ../../common/tasks/setfacts.yml
  tags:
    - deploy
    - merit

- name: Add ecodata server to the hosts file so we can connect internally
  blockinfile:
    state: present
    dest: /etc/hosts
    block: |
      {{ ecodata_server_ip }} {{ ecodata_hostname }}
    marker_begin: "# BEGIN_Use internal IP for ecodata"
    marker_end: "# END_Use internal IP for ecodata"
  tags:
    - hosts

- name: set merit user
  set_fact:
    merit_user: "{{ (exec_jar) | ternary ('fieldcapture', 'tomcat')}}"
  tags:
    - merit
    - deploy


- name: add jar and service
  include_role:
    name: exec-jar
  vars:
    service_name: "fieldcapture"
    maven_repo_url: '{{ merit_repo_url }}'
    maven_repo_username: '{{ merit_repo_username }}'
    maven_repo_password: '{{ merit_repo_password }}'
  tags:
    - deploy
    - service
    - merit
  when: exec_jar

#
# External configuration properties file
#
- name: ensure target directories exist [data subdirectories etc.]
  file: path={{item}} state=directory owner={{merit_user}} group={{merit_user}}
  with_items:
    - "{{data_dir}}/fieldcapture/config"
    - "{{data_dir}}/fieldcapture/doc"
  tags:
    - properties
    - merit

- name: copy all config.properties
  template: src=fieldcapture-config.properties dest={{data_dir}}/fieldcapture/config/fieldcapture-config.properties
  tags:
    - properties
    - merit

- name: copy logback config
  template:
    src: "{{item}}"
    dest: "{{data_dir}}/fieldcapture/config/{{item}}"
    owner: "{{merit_user}}"
    group: "{{merit_user}}"
  with_items:
    - logback.groovy
    - logback.xml
  notify:
    - restart fieldcapture
  tags:
    - properties
    - merit

- name: ensure merit log directory exists
  file: path={{item}} state=directory owner={{merit_user}} group={{merit_user}}
  with_items:
    - "/var/log/atlas/fieldcapture"
  tags:
    - properties
    - merit
  when: exec_jar

- name: set merit log ownership
  file: path=/var/log/atlas/fieldcapture owner='{{merit_user}}' group='{{merit_user}}' recurse=true
  notify:
    - restart fieldcapture
  tags:
    - properties
    - merit
  when: exec_jar

- name: set data ownership
  file: path={{data_dir}}/fieldcapture owner={{merit_user}} group={{merit_user}} recurse=true
  notify:
    - restart fieldcapture
  tags:
    - properties
    - merit

# WAR file deployment and virtual host configuration
- name: add nginx vhost if configured
  include_role:
    name: nginx_vhost
  vars:
    appname: "merit"
    hostname: "{{ merit_hostname }}"
    context_path: "{{ merit_context_path }}"
    tomcat_server_port: "{{ merit_server_port }}"
    nginx_paths:
      - path: "/doc/"
        sort_label: "1_doc"
        is_proxy: false
        alias: "/data/fieldcapture/doc"
      - path: "{{merit_context_path}}"
        sort_label: "2_ws"
        is_proxy: true
        proxy_pass: "http://127.0.0.1:{{ merit_server_port }}"
  tags:
    - nginx_vhost
  when: webserver_nginx | bool 

- name: remove trailing / in proxy pass to prevent URI decoding
  ansible.builtin.replace:
    path: /etc/nginx/sites-available/{{merit_hostname}}.conf
    regexp: '^.*proxy_pass.*$'
    replace: proxy_pass http://127.0.0.1:{{merit_server_port}};
  tags:
    - test
  when: webserver_nginx | bool 
