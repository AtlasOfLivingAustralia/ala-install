---
# Build Docker images from source
# This task file is included when build_images is true

- name: Ensure docker directory exists
  file:
    path: "{{ playbook_dir }}/../docker"
    state: directory
    mode: '0755'

- name: Check if docker buildx is available
  command: docker buildx version
  register: buildx_check
  failed_when: false
  changed_when: false

- name: Fail if buildx is not available
  fail:
    msg: "Docker buildx is not available. Please install Docker Desktop or enable buildx."
  when: buildx_check.rc != 0

- name: Display build information
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "Building images with docker buildx bake"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "  Configuration:"
      - "    - Docker Bake File: {{ data_dir }}/docker-bake.hcl"
      - "    - Registry: {{ docker_registry | default('(local)') }}"
      - "    - Tags: Using service-specific versions from inventory"
      - "      â€¢ CAS: {{ cas_version }}"
      - "      â€¢ Collectory: {{ collectory_version }}"
      - "      â€¢ Species List: {{ species_list_version }}"
      - "      â€¢ UserDetails: {{ user_details_version }}"
      - "      â€¢ APIKey: {{ apikey_version }}"
      - "      â€¢ CAS Management: {{ cas_management_version }}"
      - "    - Services: {{ services_enabled | join(', ') }}{% if i18n.enabled %} + ala-i18n{% endif %}"
      - ""
      - "  â±ï¸  Estimated time:"
      - "    - First build: 15-30 minutes (downloads base images ~500MB)"
      - "    - Subsequent builds: 2-5 minutes (uses cache)"
      - ""
      - "  ğŸ’¡ Tip: Watch progress with 'docker images' in another terminal"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

- name: Check if gradle-builder images already exist
  shell: docker image inspect gradle-builder:jdk17 > /dev/null 2>&1 && docker image inspect gradle-builder:jdk11 > /dev/null 2>&1
  register: builders_exist
  failed_when: false
  changed_when: false

- name: Display builder cache status
  debug:
    msg: "{{ 'âœ… Gradle builders already exist, skipping rebuild' if builders_exist.rc == 0 else 'ğŸ”¨ Building gradle-builder images (first time only)' }}"

- name: Build builder images first (gradle-builder)
  shell: >
    set -e;
    docker context use desktop-linux 2>/dev/null || docker context use default;
    docker buildx bake
    -f docker-bake.hcl
    --set *.cache-from=type=local,src={{ docker_build_cache_dir }}
    --set *.cache-to=type=local,dest={{ docker_build_cache_dir }},mode=max
    --allow=fs={{ ansible_env.HOME }}/.cache
    --allow=fs.read=../docker
    --progress=plain
    --load
    builders
    2>&1 | tee /tmp/docker-build-builders.log
  args:
    chdir: "{{ data_dir }}"
    executable: /bin/bash
  register: build_builders
  changed_when: true
  when: services_enabled | length > 0 and builders_exist.rc != 0
  async: 1800
  poll: 0

- name: Wait for builder build to start (check log file)
  wait_for:
    path: /tmp/docker-build-builders.log
    timeout: 30
  when: services_enabled | length > 0 and builders_exist.rc != 0

- name: Monitor builder build progress
  shell: |
    while kill -0 {{ build_builders.ansible_job_id }} 2>/dev/null; do
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸ”¨ Building gradle-builder images..."
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      tail -15 /tmp/docker-build-builders.log | grep -E '#[0-9]+|DONE|CACHED|downloading|extracting|exporting' || tail -5 /tmp/docker-build-builders.log
      echo ""
      echo "ğŸ’¡ Full log: tail -f /tmp/docker-build-builders.log"
      echo ""
      sleep 15
    done
  args:
    executable: /bin/bash
  when: services_enabled | length > 0 and builders_exist.rc != 0
  register: monitor_builders
  async: 1800
  poll: 0

- name: Wait for builder images to finish
  async_status:
    jid: "{{ build_builders.ansible_job_id }}"
  register: build_result
  until: build_result.finished
  retries: 180
  delay: 10
  when: services_enabled | length > 0 and builders_exist.rc != 0

- name: Stop monitoring
  async_status:
    jid: "{{ monitor_builders.ansible_job_id }}"
    mode: cleanup
  when: services_enabled | length > 0
  ignore_errors: true

- name: Build service images
  shell: >
    set -e;
    docker context use desktop-linux 2>/dev/null || docker context use default;
    docker buildx bake
    -f docker-bake.hcl
    --set *.cache-from=type=local,src={{ docker_build_cache_dir }}
    --set *.cache-to=type=local,dest={{ docker_build_cache_dir }},mode=max
    --allow=fs={{ ansible_env.HOME }}/.cache
    --allow=fs.read=../docker
    --progress=plain
    --load
    services
    2>&1 | tee /tmp/docker-build-services.log
  args:
    chdir: "{{ data_dir }}"
    executable: /bin/bash
  register: build_services
  changed_when: true
  when: services_enabled | length > 0
  async: 3600
  poll: 0

- name: Wait for service build to start
  wait_for:
    path: /tmp/docker-build-services.log
    timeout: 30
  when: services_enabled | length > 0

- name: Monitor service build progress
  shell: |
    while kill -0 {{ build_services.ansible_job_id }} 2>/dev/null; do
      clear
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸš€ Building service images: {{ services_enabled | join(', ') }}"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      tail -20 /tmp/docker-build-services.log | grep -E '#[0-9]+|DONE|CACHED|downloading|extracting|exporting|Downloading|Compiling|Task :' || tail -10 /tmp/docker-build-services.log
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "ğŸ’¡ Full log: tail -f /tmp/docker-build-services.log"
      echo "ğŸ• $(date '+%H:%M:%S')"
      echo ""
      sleep 15
    done
  args:
    executable: /bin/bash
  async: 3600
  poll: 0
  when: services_enabled | length > 0
  register: monitor_services

- name: Wait for service images to finish
  async_status:
    jid: "{{ build_services.ansible_job_id }}"
  register: services_result
  until: services_result.finished
  retries: 360
  delay: 10
  when: services_enabled | length > 0

- name: Stop service monitoring
  async_status:
    jid: "{{ monitor_services.ansible_job_id }}"
    mode: cleanup
  when: services_enabled | length > 0
  ignore_errors: true

- name: Display build results
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "âœ… Images built successfully!"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "  Built services with versions:"
      - "    â€¢ CAS: {{ cas_version | default('N/A') }}"
      - "    â€¢ Collectory: {{ collectory_version | default('N/A') }}"
      - "    â€¢ Species List: {{ species_list_version | default('N/A') }}"
      - "    â€¢ UserDetails: {{ user_details_version | default('N/A') }}"
      - "    â€¢ APIKey: {{ apikey_version | default('N/A') }}"
      - "    â€¢ CAS Management: {{ cas_management_version | default('N/A') }}"
      - ""
      - "  Verify with: docker images"
      - ""
      - "  Next steps:"
      - "    - Start services: docker compose -f {{ data_dir }}/docker-compose.yml up -d"
      - "    - Check status: docker compose ps"
      - "    - View logs: docker compose logs -f"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

