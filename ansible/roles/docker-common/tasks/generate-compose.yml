---
# Generate docker-compose.yml from templates
# Using existing ala-install variables

- name: Set docker facts for all services
  set_fact:
    docker_default_user: "{{ docker_compose_userid | default(ansible_env.SUDO_USER) | default(ansible_user_id) }}"
    # Core user variables for all services
    tomcat_user: "{{ docker_compose_userid | default(ansible_env.SUDO_USER) | default(ansible_user_id) }}"
    nginx_user: "{{ docker_compose_userid | default(ansible_env.SUDO_USER) | default(ansible_user_id) }}"
    cas_user: "{{ docker_compose_userid | default(ansible_env.SUDO_USER) | default(ansible_user_id) }}"
    collectory_user: "{{ docker_compose_userid | default(ansible_env.SUDO_USER) | default(ansible_user_id) }}"
    userdetails_user: "{{ docker_compose_userid | default(ansible_env.SUDO_USER) | default(ansible_user_id) }}"
    apikey_user: "{{ docker_compose_userid | default(ansible_env.SUDO_USER) | default(ansible_user_id) }}"
    namematching_user: "{{ docker_compose_userid | default(ansible_env.SUDO_USER) | default(ansible_user_id) }}"
    sensitive_data_user: "{{ docker_compose_userid | default(ansible_env.SUDO_USER) | default(ansible_user_id) }}"
    # Docker host variables for services (WIP, comented for now)
    # collectory_docker_host: "{{ collectory_docker_host | default('la_collectory_war') }}"
    # userdetails_docker_host: "{{ userdetails_docker_host | default('la_auth_userdetails') }}"
    # CAS MongoDB flags
    cas_add_mongo_users: "{{ cas_add_mongo_users | default(true) }}"

- name: Debug - Docker user configuration
  debug:
    msg: "Docker users - tomcat: {{ tomcat_user }}, nginx: {{ nginx_user }}, cas: {{ cas_user }}, collectory: {{ collectory_user }}, userdetails: {{ userdetails_user }}, apikey: {{ apikey_user }}"

- name: Ensure output directory exists
  file:
    path: "{{ data_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"

- name: Include services descriptions
  include_vars:
    file: docker-services-desc.yaml

- name: Set docker_services_desc as a clean variable
  set_fact:
    docker_services_desc: "{{ docker_services_desc }}"

- name: Determine Java versions for services
  include_tasks: determine-java-versions.yml

# Create clean dictionaries for easy access to software and Java versions
# Uses version_variable from docker_services_desc dynamically
- name: Build service versions dictionary from docker_services_desc
  set_fact:
    service_versions_dict: "{{ service_versions_dict | default({}) | combine({item.key: vars[item.value.version_variable] | default('develop')}) }}"
  loop: "{{ docker_services_desc | dict2items }}"
  when: item.value.version_variable is defined
  loop_control:
    label: "{{ item.key }}"

- name: Build Java versions dictionary from determined java versions
  set_fact:
    service_java_dict: >-
      {{
        service_java_dict | default({}) | combine({
          item.key: vars.get(item.key.replace('-', '_') + '_java_version', item.value.get('java_version', '11'))
        })
      }}
  loop: "{{ docker_services_desc | dict2items }}"
  when:
    - vars.get(item.key.replace('-', '_') + '_java_version') is defined or item.value.get('java_version') is defined
  loop_control:
    label: "{{ item.key }}"

- name: Fetch latest ala-i18n version from apt.gbif.es repository
  block:
    - name: Download Packages.gz and extract version
      shell: |
        curl -s https://apt.gbif.es/dists/unstable/main/binary-amd64/Packages.gz | \
        gunzip | \
        awk '/^Package: ala-i18n$/{p=1; next} p && /^Version:/{print $2; p=0}' | \
        sort -V | \
        tail -1 | \
        sed 's/~.*//' | \
        sed 's/+.*//'
      register: gbif_i18n_version
      changed_when: false
      failed_when: false

    - name: Set i18n_version from apt.gbif.es
      set_fact:
        i18n_version: "{{ gbif_i18n_version.stdout | trim }}"
      when: gbif_i18n_version.stdout | length > 0

    - name: Display fetched i18n version
      debug:
        msg: "Latest ala-i18n version from apt.gbif.es: {{ i18n_version | default('unable to fetch') }}"

- name: Detect enabled services from optional flag and use_* inventory variables
  set_fact:
    services_enabled: "{{ services_enabled | default([]) + ([item.key] if (
      (not item.value.optional | default(true)) or 
      (item.value.isSubService | default(false) and vars.get('use_' + docker_services_desc[item.value.parentService].nameInt, false) | bool) or
      (not item.value.isSubService | default(false) and vars.get('use_' + item.value.nameInt, false) | bool)
    ) else []) }}"
  loop: "{{ docker_services_desc | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

# Always add nginx and ensure unique services
# Note: gatus is launched directly as an external image (like nginx) without custom Dockerfile
- name: Add nginx and ensure unique services list
  set_fact:
    services_enabled: "{{ (['nginx'] + services_enabled) | unique | difference(['gatus']) }}"

- name: Debug - Show services configuration
  debug:
    msg: "Services enabled: {{ services_enabled }}"

# Create nginx directories BEFORE any role tries to use nginx_vhost
- name: Ensure nginx config directory exists
  file:
    path: "{{ nginx_conf_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: "'nginx' in services_enabled"

- name: Ensure nginx conf.d directory exists
  file:
    path: "{{ nginx_conf_dir }}/conf.d"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: "'nginx' in services_enabled"

- name: Ensure nginx sites-enabled directory exists
  file:
    path: "{{ nginx_conf_dir }}/sites-enabled"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: "'nginx' in services_enabled"

- name: Run cas configuration generation
  include_role:
    name: cas5
  vars:
    deployment_type: container
  when:
    - "'cas' in services_enabled"
  tags:
    - cas
    - config

- name: Run userdetails configuration generation
  include_role:
    name: userdetails
  vars:
    deployment_type: container
  when:
    - "'userdetails' in services_enabled"
  tags:
    - userdetails
    - config

- name: Run apikey configuration generation
  include_role:
    name: apikey
  vars:
    deployment_type: container
  when:
    - "'apikey' in services_enabled"
  tags:
    - apikey
    - config

- name: Run cas-management configuration generation
  include_role:
    name: cas-management
  vars:
    deployment_type: container
  when:
    - "'cas_management' in services_enabled"
  tags:
    - cas-management
    - config

- name: Load collectory role variables if needed
  include_vars:
    file: "{{ playbook_dir }}/roles/collectory/vars/main.yml"

# Ensure database password variables have values (from inventory or defaults)
# These are critical for docker-compose .env generation
- name: Ensure database password variables are set
  set_fact:
    mysql_root_password: "{{ mysql_root_password | default('generated_mysql_password') }}"
    collectory_db_password: "{{ collectory_db_password | default('generated_collectory_password') }}"
    mongodb_root_password: "{{ mongodb_root_password | default('generated_mongodb_password') }}"
    mongodb_root_username: "{{ mongodb_root_username | default('admin') }}"

# Create common directories BEFORE any role tries to use them
- name: Run common directory and config setup
  include_tasks: common.yml

# Now run collectory and other services
- name: Run collectory configuration generation (asset copy, config templates)
  include_role:
    name: collectory
  vars:
    deployment_type: container
  when: "'collectory' in services_enabled"
  tags:
    - collectory
    - config

- name: Ensure database init directories exist with correct permissions
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  loop:
    - "{{ data_dir }}/mysql/init"
    - "{{ data_dir }}/mongodb/init"

- name: Set CAS database variables from inventories for MongoDB initialization
  set_fact:
    cas_tickets_username: "{{ cas_tickets_username | default('cas-ticket-user') }}"
    cas_tickets_password: "{{ cas_tickets_password | default(lookup('password', '/dev/null length=20')) }}"
    cas_tickets_db: "{{ cas_tickets_db | default('cas-ticket-registry') }}"
    cas_services_username: "{{ cas_services_username | default('cas-services-user') }}"
    cas_services_password: "{{ cas_services_password | default(lookup('password', '/dev/null length=20')) }}"
    cas_services_db: "{{ cas_services_db | default('cas-service-registry') }}"
    cas_audit_username: "{{ cas_audit_username | default('cas-audit-user') }}"
    cas_audit_password: "{{ cas_audit_password | default(lookup('password', '/dev/null length=20')) }}"
    cas_audit_db: "{{ cas_audit_db | default('cas-audit-repository') }}"
    cas_spring_session_username: "{{ cas_spring_session_username | default('cas-session-user') }}"
    cas_spring_session_password: "{{ cas_spring_session_password | default(lookup('password', '/dev/null length=20')) }}"
    spring_session_mongo_collection: "{{ spring_session_mongo_collection | default('spring-sessions') }}"
  when: "'cas' in services_enabled"

- name: Generate MongoDB initialization script
  template:
    src: mongodb-init.js.j2
    dest: "{{ data_dir }}/mongodb/init/init-users.js"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: "'cas' in services_enabled"

# Build JAVA_OPTS for each service from inventory variables
- name: Build JAVA_OPTS strings for each service
  set_fact:
    temp_java_opts: "{{ temp_java_opts | default({}) | combine({
      item: '-Djava.awt.headless=true -Xmx' +
            (vars.get(item.replace('-', '_') + '_max_memory', '2g')) +
            ' -Xms' +
            (vars.get(item.replace('-', '_') + '_min_memory', '1g')) +
            ' ' +
            (vars.get('java_security_opts', '-Dlog4j2.formatMsgNoLookups=true'))
    }) }}"
  loop: "{{ services_enabled | difference(['nginx', 'gatus', 'mysql', 'mongodb']) }}"

# Build service_extra_params dict for templates
- name: Build extra_params dict for services
  set_fact:
    service_extra_params: "{{ service_extra_params | default({}) | combine({
      item: docker_services_desc.get(item, {}).get('extra_params', [])
    }) }}"
  loop: "{{ services_enabled | difference(['nginx', 'gatus', 'mysql', 'mongodb']) }}"

- name: Set service_java_opts_dict from temp_java_opts
  set_fact:
    service_java_opts_dict: "{{ temp_java_opts }}"

- name: Debug - Show service_extra_params (extra JVM parameters defined per service)
  debug:
    msg: |
      Services with extra_params that will be concatenated in .env:
      {% for service, extras in service_extra_params.items() %}
      {% if extras %}
        {{ service }}: {{ extras | map(attribute='key') | list | join(', ') }}
      {% endif %}
      {% endfor %}

- name: Debug - Show generated JAVA_OPTS for services (BASE - extras added in template)
  debug:
    msg: "{{ service_java_opts_dict }}"

- name: Generate .env file with database passwords from inventories
  template:
    src: docker-compose.env.j2
    dest: "{{ data_dir }}/.env"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"

- name: Generate docker-compose.yml
  template:
    src: docker-compose/base.yml.j2
    dest: "{{ data_dir }}/docker-compose.yml"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"

- name: Fix docker-compose build paths (relative to docker-compose-output/)
  replace:
    path: "{{ data_dir }}/docker-compose.yml"
    regexp: 'context: \./docker/'
    replace: 'context: ../docker/'
  when: data_dir is defined

# Note: service_versions is now dynamically built from docker_services_desc
# via service_versions_dict and service_java_dict

# Create directories for enabled services with build tools
- name: Create directories for Dockerfile generation
  file:
    path: "{{ playbook_dir | dirname }}/docker/{{ docker_services_desc[item].role }}"
    state: directory
    mode: '0755'
  loop: "{{ services_enabled }}"
  when:
    - item in docker_services_desc
    - docker_services_desc[item].get('buildTool') in ['gradle', 'maven']

# Generate Gradle Dockerfiles using already-determined Java versions
- name: Generate Gradle Dockerfiles
  template:
    src: "Dockerfile.gradle.j2"
    dest: "{{ playbook_dir | dirname }}/docker/{{ docker_services_desc[item].role }}/Dockerfile"
    mode: '0644'
  loop: "{{ services_enabled }}"
  vars:
    service_name: "{{ item }}"
    description: "{{ docker_services_desc[item].desc }}"
    artifact_id: "{{ docker_services_desc[item].artifacts }}"
    # Java version from service_java_dict
    java_version: "{{ service_java_dict.get(item, '11') }}"
    repo: "{{ docker_services_desc[item].repository | default('') }}"
    branch: "develop"
    port: "8080"
    service_classifier: "{{ docker_services_desc[item].get('classifier') | default('') }}"
    # Version from service_versions_dict
    service_version: "{{ service_versions_dict.get(item, 'develop') }}"
    log_dir: "{{ docker_services_desc[item].get('log_dir') }}"
  when:
    - item in docker_services_desc
    - docker_services_desc[item].get('buildTool') == 'gradle'

# Generate Maven Dockerfiles using already-determined Java versions
- name: Generate Maven Dockerfiles
  template:
    src: "Dockerfile.maven.j2"
    dest: "{{ playbook_dir | dirname }}/docker/{{ docker_services_desc[item].role }}/Dockerfile"
    mode: '0644'
  loop: "{{ services_enabled }}"
  vars:
    service_name: "{{ item }}"
    description: "{{ docker_services_desc[item].desc }}"
    artifact_id: "{{ docker_services_desc[item].artifacts }}"
    # Java version from service_java_dict
    java_version: "{{ service_java_dict.get(item) }}"
    repo: "{{ docker_services_desc[item].repository | default('') }}"
    branch: "develop"
    port: "8080"
    service_classifier: "{{ docker_services_desc[item].get('classifier') | default('') }}"
    # Version from service_versions_dict
    service_version: "{{ service_versions_dict.get(item, 'develop') }}"
    log_dir: "{{ docker_services_desc[item].get('log_dir') }}"
  when:
    - item in docker_services_desc
    - docker_services_desc[item].get('buildTool') == 'maven'

- name: Display generated Dockerfiles with versions and Java
  debug:
    msg: |
      âœ… Generated Dockerfiles:
      {% for service in services_enabled %}
      {% if service in docker_services_desc and docker_services_desc[service].get('build_tool') in ['gradle', 'maven'] %}
      {% set svc_version = (
        collectory_version if service == 'collectory' else
        cas_version if service == 'cas' else
        user_details_version if service == 'userdetails' else
        apikey_version if service == 'apikey' else
        cas_management_version if service == 'cas-management' else
        species_list_version if service == 'species-lists' else
        bie_hub_version if service == 'ala-bie' else
        spatial_hub_version if service == 'spatial' else
        regions_version if service == 'regions' else
        bie_index_version if service == 'species' else
        image_service_version if service == 'images' else
        alerts_version if service == 'alerts' else
        doi_service_version if service == 'doi' else
        dashboard_version if service == 'dashboard' else
        sds_version if service == 'sds' else
        biocollect_version if service == 'biocollect' else
        ala_namematching_service_version if service == 'namematching' else
        ala_sensitive_data_service_version if service == 'sensitive-data' else
        data_quality_filter_service_version if service == 'data-quality' else
        'develop'
      ) | default('develop') %}
      {% set svc_java = vars[service.replace('-', '_') + '_java_version'] | default(docker_services_desc[service].java_version) %}
      - docker/{{ service }}/Dockerfile ({{ docker_services_desc[service].build_tool }}) v{{ svc_version }} (Java {{ svc_java }})
      {% endif %}
      {% endfor %}

- name: Remove old docker-bake.hcl to force regeneration
  file:
    path: "{{ data_dir }}/docker-bake.hcl"
    state: absent
  when: build_images | default(false)

- name: Generate docker-bake.hcl for optimized builds
  template:
    src: docker-bake.hcl.j2
    dest: "{{ data_dir }}/docker-bake.hcl"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: build_images | default(false)


- name: Generate nginx configuration
  template:
    src: nginx/default.conf.j2
    dest: "{{ nginx_conf_dir }}/default.conf"
    mode: '0644'
  when: "'nginx' in services_enabled"

# Reuse role tasks for other services
# Each role handles its own configuration generation
- name: Run species-list configuration generation
  include_role:
    name: species-list
  vars:
    deployment_type: container
  when: "'species_lists' in services_enabled"
  tags:
    - species-list
    - config

- name: Run gatus configuration generation
  include_role:
    name: gatus
  vars:
    deployment_type: container
  when: "'gatus' in services_enabled"
  tags:
    - gatus
    - config

- name: Include build-images tasks
  include_tasks: build-images.yml
  when: build_images | default(false)

- name: Display generated compose file location
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ğŸ“„ Docker Compose Configuration Generated"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "  Location: {{ data_dir }}/"
      - "  Files:"
      - "    - docker-compose.yml"
      - "{% if build_images | default(false) %}    - docker-bake.hcl{% endif %}"
      - "{% if 'nginx' in services_enabled %}    - nginx/default.conf{% endif %}"
      - "{% if 'collectory' in services_enabled %}    - collectory/config/collectory-config.properties{% endif %}"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
#
#- name: Fix ownership of configuration files (user-relevant files only)
#  shell: |
#    # Fix docker-compose.yml
#    if [ -f "{{ data_dir }}/docker-compose.yml" ]; then
#      chown {{ ansible_user_id }}:{{ ansible_user_gid }} "{{ data_dir }}/docker-compose.yml"    fi
#
#    # Fix nginx configuration
#    if [ -d "{{ data_dir }}/nginx" ]; then
#      chown -R {{ ansible_user_id }}:{{ ansible_user_gid }} "{{ data_dir }}/nginx"
#      find "{{ data_dir }}/nginx" -type d -exec chmod 0755 {} \;
#      find "{{ data_dir }}/nginx" -type f -exec chmod 0644 {} \;
#    fi
#  changed_when: false
#  become: yes

