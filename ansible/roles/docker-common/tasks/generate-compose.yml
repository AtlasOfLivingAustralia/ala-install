---
# Generate docker-compose.yml from templates
# Using existing ala-install variables

- name: Ensure output directory exists
  file:
    path: "{{ data_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"

- name: Determine Java versions for services
  include_tasks: determine-java-versions.yml

- name: Fetch latest ala-i18n version from GBIF APT repository
  block:
    - name: Download GBIF Packages.gz and extract version
      shell: |
        curl -s https://apt.gbif.es/dists/unstable/main/binary-amd64/Packages.gz | \
        gunzip | \
        awk '/^Package: ala-i18n$/{p=1; next} p && /^Version:/{print $2; p=0}' | \
        sort -V | \
        tail -1 | \
        sed 's/~.*//' | \
        sed 's/+.*//'
      register: gbif_i18n_version
      changed_when: false
      failed_when: false

    - name: Set i18n_version from GBIF
      set_fact:
        i18n_version: "{{ gbif_i18n_version.stdout | trim }}"
      when: gbif_i18n_version.stdout | length > 0

    - name: Display fetched i18n version
      debug:
        msg: "Latest ala-i18n version from GBIF: {{ i18n_version | default('unable to fetch') }}"

- name: Detect enabled services from use_* inventory variables
  set_fact:
    services_enabled: >-
      {{
        (['collectory', 'nginx'] +
        (['cas', 'userdetails', 'apikey', 'cas-management'] if (use_cas | default(false) | bool) else []) +
        (['oidc'] if (use_oidc | default(false) | bool) else []) +
        (['ala-bie'] if (use_ala_bie | default(false) | bool) else []) +
        (['spatial'] if (use_spatial | default(false) | bool) else []) +
        (['regions'] if (use_regions | default(false) | bool) else []) +
        (['species'] if (use_species | default(false) | bool) else []) +
        (['species-lists'] if (use_species_lists | default(false) | bool) else []) +
        (['images'] if (use_images | default(false) | bool) else []) +
        (['alerts'] if (use_alerts | default(false) | bool) else []) +
        (['doi'] if (use_doi | default(false) | bool) else []) +
        (['webapi'] if (use_webapi | default(false) | bool) else []) +
        (['dashboard'] if (use_dashboard | default(false) | bool) else []) +
        (['biocache-backend'] if (use_biocache_backend | default(false) | bool) else []) +
        (['pipelines'] if (use_pipelines | default(false) | bool) else []) +
        (['solrcloud'] if (use_solrcloud | default(false) | bool) else []) +
        (['sds'] if (use_sds | default(false) | bool) else []) +
        (['biocollect'] if (use_biocollect | default(false) | bool) else []) +
        (['namematching'] if (use_namematching_service | default(false) | bool) else []) +
        (['sensitive-data'] if (use_sensitive_data_service | default(false) | bool) else []) +
        (['data-quality'] if (use_data_quality | default(false) | bool) else []) +
        (['events'] if (use_events | default(false) | bool) else []) +
        (['events-elasticsearch'] if (use_events_elasticsearch | default(false) | bool) else []) +
        (['gatus'] if (use_gatus | default(false) | bool) else []))
        | unique
      }}

- name: Debug services_enabled
  debug:
    msg: "Services enabled: {{ services_enabled }}"

- name: Debug individual use_* variables
  debug:
    msg: |
      use_cas = {{ use_cas | default(false) }}
      use_oidc = {{ use_oidc | default(false) }}
      use_collectory = {{ use_collectory | default(false) }}
      use_ala_bie = {{ use_ala_bie | default(false) }}
      use_spatial = {{ use_spatial | default(false) }}

- name: Debug services_enabled list
  debug:
    msg: "{{ services_enabled | to_nice_yaml }}"

- name: Verify cas in services_enabled
  debug:
    msg: "'cas' in services_enabled = {{ 'cas' in services_enabled }}"

- name: Verify userdetails in services_enabled
  debug:
    msg: "'userdetails' in services_enabled = {{ 'userdetails' in services_enabled }}"

- name: Assert cas should be in services_enabled if use_cas is true
  assert:
    that:
      - "'cas' in services_enabled or not (use_cas | default(false) | bool)"
    fail_msg: "ERROR: cas should be in services_enabled when use_cas=true. Got: {{ services_enabled }}"

- name: Run cas configuration generation
  include_role:
    name: cas5
  vars:
    deployment_type: container
  when: "'cas' in services_enabled"
  tags:
    - cas
    - config

- name: Run userdetails configuration generation
  include_role:
    name: userdetails
  vars:
    deployment_type: container
  when: "'userdetails' in services_enabled"
  tags:
    - userdetails
    - config

- name: Run apikey configuration generation
  include_role:
    name: apikey
  vars:
    deployment_type: container
  when: "'apikey' in services_enabled"
  tags:
    - apikey
    - config

- name: Run cas-management configuration generation
  include_role:
    name: cas-management
  vars:
    deployment_type: container
  when: "'cas-management' in services_enabled"
  tags:
    - cas-management
    - config

- name: Load collectory role variables if needed
  include_vars:
    file: "{{ playbook_dir }}/roles/collectory/vars/main.yml"

# Ensure database password variables have values (from inventory or defaults)
# These are critical for docker-compose .env generation
- name: Ensure database password variables are set
  set_fact:
    mysql_root_password: "{{ mysql_root_password | default('generated_mysql_password') }}"
    collectory_db_password: "{{ collectory_db_password | default('generated_collectory_password') }}"
    mongodb_root_password: "{{ mongodb_root_password | default('generated_mongodb_password') }}"
    mongodb_root_username: "{{ mongodb_root_username | default('admin') }}"

# Create common directories BEFORE any role tries to use them
- name: Run common directory and config setup
  include_tasks: common.yml

# Now run collectory and other services
- name: Run collectory configuration generation (asset copy, config templates)
  include_role:
    name: collectory
  vars:
    deployment_type: container
  when: "'collectory' in services_enabled"
  tags:
    - collectory
    - config

- name: Ensure database init directories exist with correct permissions
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  loop:
    - "{{ data_dir }}/mysql/init"
    - "{{ data_dir }}/mongodb/init"

- name: Set CAS database variables from inventories for MongoDB initialization
  set_fact:
    cas_tickets_username: "{{ cas_tickets_username | default('cas-ticket-user') }}"
    cas_tickets_password: "{{ cas_tickets_password | default(lookup('password', '/dev/null length=20')) }}"
    cas_tickets_db: "{{ cas_tickets_db | default('cas-ticket-registry') }}"
    cas_services_username: "{{ cas_services_username | default('cas-services-user') }}"
    cas_services_password: "{{ cas_services_password | default(lookup('password', '/dev/null length=20')) }}"
    cas_services_db: "{{ cas_services_db | default('cas-service-registry') }}"
    cas_audit_username: "{{ cas_audit_username | default('cas-audit-user') }}"
    cas_audit_password: "{{ cas_audit_password | default(lookup('password', '/dev/null length=20')) }}"
    cas_audit_db: "{{ cas_audit_db | default('cas-audit-repository') }}"
    cas_spring_session_username: "{{ cas_spring_session_username | default('cas-session-user') }}"
    cas_spring_session_password: "{{ cas_spring_session_password | default(lookup('password', '/dev/null length=20')) }}"
    spring_session_mongo_collection: "{{ spring_session_mongo_collection | default('spring-sessions') }}"
  when: "'cas' in services_enabled"

- name: Generate MongoDB initialization script
  template:
    src: mongodb-init.js.j2
    dest: "{{ data_dir }}/mongodb/init/init-users.js"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: "'cas' in services_enabled"

- name: Generate .env file with database passwords from inventories
  template:
    src: docker-compose.env.j2
    dest: "{{ data_dir }}/.env"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"

- name: Generate docker-compose.yml
  template:
    src: docker-compose/base.yml.j2
    dest: "{{ data_dir }}/docker-compose.yml"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"

- name: Fix docker-compose build paths (relative to docker-compose-output/)
  replace:
    path: "{{ data_dir }}/docker-compose.yml"
    regexp: 'context: \./docker/'
    replace: 'context: ../docker/'
  when: data_dir is defined

# Create a dictionary mapping service names to their versions
- name: Create service versions dictionary
  set_fact:
    service_versions:
      collectory: "{{ collectory_version | default('develop') }}"
      cas: "{{ cas_version | default('develop') }}"
      userdetails: "{{ user_details_version | default('develop') }}"
      apikey: "{{ apikey_version | default('develop') }}"
      cas-management: "{{ cas_management_version | default('develop') }}"
      species-lists: "{{ species_list_version | default('develop') }}"
      ala-bie: "{{ bie_hub_version | default('develop') }}"
      spatial: "{{ spatial_hub_version | default('develop') }}"
      regions: "{{ regions_version | default('develop') }}"
      species: "{{ bie_index_version | default('develop') }}"
      images: "{{ image_service_version | default('develop') }}"
      alerts: "{{ alerts_version | default('develop') }}"
      doi: "{{ doi_service_version | default('develop') }}"
      dashboard: "{{ dashboard_version | default('develop') }}"
      sds: "{{ sds_version | default('develop') }}"
      biocollect: "{{ biocollect_version | default('develop') }}"
      namematching: "{{ ala_namematching_service_version | default('develop') }}"
      sensitive-data: "{{ ala_sensitive_data_service_version | default('develop') }}"
      data-quality: "{{ data_quality_filter_service_version | default('develop') }}"

# Create directories for enabled services with build tools
- name: Create directories for Dockerfile generation
  file:
    path: "{{ playbook_dir | dirname }}/docker/{{ item }}"
    state: directory
    mode: '0755'
  loop: "{{ services_enabled }}"
  when:
    - item in docker_services_config
    - docker_services_config[item].get('build_tool') in ['gradle', 'maven']

# Generate Gradle Dockerfiles using already-determined Java versions
- name: Generate Gradle Dockerfiles
  template:
    src: "Dockerfile.gradle.j2"
    dest: "{{ playbook_dir | dirname }}/docker/{{ item }}/Dockerfile"
    mode: '0644'
  loop: "{{ services_enabled }}"
  vars:
    service_name: "{{ item }}"
    description: "{{ docker_services_config[item].description }}"
    artifact_id: "{{ docker_services_config[item].artifact_id }}"
    group_id: "{{ docker_services_config[item].group_id }}"
    # Java version from variables calculated in determine-java-versions.yml
    java_version: "{{ vars[item.replace('-', '_') + '_java_version'] | default(docker_services_config[item].java_version) }}"
    runtime_image: "{{ docker_services_config[item].runtime_image }}"
    repo: "{{ docker_services_config[item].repo }}"
    branch: "{{ docker_services_config[item].branch }}"
    port: "{{ docker_services_config[item].port }}"
    classifier: "{{ docker_services_config[item].classifier | default('') }}"
    # Version from service_versions dictionary
    version: "{{ service_versions[item] | default(docker_services_config[item].branch) }}"
  when:
    - item in docker_services_config
    - docker_services_config[item].build_tool == 'gradle'

# Generate Maven Dockerfiles using already-determined Java versions
- name: Generate Maven Dockerfiles
  template:
    src: "Dockerfile.maven.j2"
    dest: "{{ playbook_dir | dirname }}/docker/{{ item }}/Dockerfile"
    mode: '0644'
  loop: "{{ services_enabled }}"
  vars:
    service_name: "{{ item }}"
    description: "{{ docker_services_config[item].description }}"
    artifact_id: "{{ docker_services_config[item].artifact_id }}"
    group_id: "{{ docker_services_config[item].group_id }}"
    # Java version from variables calculated in determine-java-versions.yml
    java_version: "{{ vars[item.replace('-', '_') + '_java_version'] | default(docker_services_config[item].java_version) }}"
    runtime_image: "{{ docker_services_config[item].runtime_image }}"
    repo: "{{ docker_services_config[item].repo }}"
    branch: "{{ docker_services_config[item].branch }}"
    port: "{{ docker_services_config[item].port }}"
    classifier: "{{ docker_services_config[item].classifier | default('') }}"
    # Version from service_versions dictionary
    version: "{{ service_versions[item] | default(docker_services_config[item].branch) }}"
  when:
    - item in docker_services_config
    - docker_services_config[item].build_tool == 'maven'

- name: Display generated Dockerfiles with versions and Java
  debug:
    msg: |
      âœ… Generated Dockerfiles:
      {% for service in services_enabled %}
      {% if service in docker_services_config and docker_services_config[service].get('build_tool') in ['gradle', 'maven'] %}
      {% set svc_version = (
        collectory_version if service == 'collectory' else
        cas_version if service == 'cas' else
        user_details_version if service == 'userdetails' else
        apikey_version if service == 'apikey' else
        cas_management_version if service == 'cas-management' else
        species_list_version if service == 'species-lists' else
        bie_hub_version if service == 'ala-bie' else
        spatial_hub_version if service == 'spatial' else
        regions_version if service == 'regions' else
        bie_index_version if service == 'species' else
        image_service_version if service == 'images' else
        alerts_version if service == 'alerts' else
        doi_service_version if service == 'doi' else
        dashboard_version if service == 'dashboard' else
        sds_version if service == 'sds' else
        biocollect_version if service == 'biocollect' else
        ala_namematching_service_version if service == 'namematching' else
        ala_sensitive_data_service_version if service == 'sensitive-data' else
        data_quality_filter_service_version if service == 'data-quality' else
        'develop'
      ) | default('develop') %}
      {% set svc_java = vars[service.replace('-', '_') + '_java_version'] | default(docker_services_config[service].java_version) %}
      - docker/{{ service }}/Dockerfile ({{ docker_services_config[service].build_tool }}) v{{ svc_version }} (Java {{ svc_java }})
      {% endif %}
      {% endfor %}

- name: Remove old docker-bake.hcl to force regeneration
  file:
    path: "{{ data_dir }}/docker-bake.hcl"
    state: absent
  when: build_images | default(false)

- name: Generate docker-bake.hcl for optimized builds
  template:
    src: docker-bake.hcl.j2
    dest: "{{ data_dir }}/docker-bake.hcl"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: build_images | default(false)

- name: Ensure nginx config directory exists
  file:
    path: "{{ nginx_conf_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: "'nginx' in services_enabled"

- name: Generate nginx configuration
  template:
    src: nginx/default.conf.j2
    dest: "{{ nginx_conf_dir }}/default.conf"
    mode: '0644'
  when: "'nginx' in services_enabled"

# Reuse role tasks for other services
# Each role handles its own configuration generation
- name: Run species-list configuration generation
  include_role:
    name: species-list
  vars:
    deployment_type: container
  when: "'species-lists' in services_enabled"
  tags:
    - species-list
    - config

- name: Run gatus configuration generation
  include_role:
    name: gatus
  vars:
    deployment_type: container
  when: "'gatus' in services_enabled"
  tags:
    - gatus
    - config

- name: Include build-images tasks
  include_tasks: build-images.yml
  when: build_images | default(false)

- name: Display generated compose file location
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ğŸ“„ Docker Compose Configuration Generated"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "  Location: {{ data_dir }}/"
      - "  Files:"
      - "    - docker-compose.yml"
      - "{% if build_images | default(false) %}    - docker-bake.hcl{% endif %}"
      - "{% if 'nginx' in services_enabled %}    - nginx/default.conf{% endif %}"
      - "{% if 'collectory' in services_enabled %}    - collectory/config/collectory-config.properties{% endif %}"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

- name: Fix ownership of configuration files (user-relevant files only)
  shell: |
    # Fix docker-compose.yml
    if [ -f "{{ data_dir }}/docker-compose.yml" ]; then
      chown {{ ansible_user_id }}:{{ ansible_user_gid }} "{{ data_dir }}/docker-compose.yml"    fi
    
    # Fix nginx configuration
    if [ -d "{{ data_dir }}/nginx" ]; then
      chown -R {{ ansible_user_id }}:{{ ansible_user_gid }} "{{ data_dir }}/nginx"
      find "{{ data_dir }}/nginx" -type d -exec chmod 0755 {} \;
      find "{{ data_dir }}/nginx" -type f -exec chmod 0644 {} \;
    fi
  changed_when: false
  become: yes

