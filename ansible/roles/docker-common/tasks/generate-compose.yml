---
# Generate docker-compose.yml from templates
# Using existing ala-install variables

- name: Ensure output directory exists
  file:
    path: "{{ data_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"

- name: Determine Java versions for services
  include_tasks: determine-java-versions.yml


- name: Detect enabled services from use_* inventory variables
  set_fact:
    services_enabled: >-
      {{
        (['collectory', 'nginx'] +
        (['cas', 'userdetails', 'apikey', 'cas-management'] if (use_cas | default(false) | bool) else []) +
        (['oidc'] if (use_oidc | default(false) | bool) else []) +
        (['ala-bie'] if (use_ala_bie | default(false) | bool) else []) +
        (['spatial'] if (use_spatial | default(false) | bool) else []) +
        (['regions'] if (use_regions | default(false) | bool) else []) +
        (['species'] if (use_species | default(false) | bool) else []) +
        (['species-lists'] if (use_species_lists | default(false) | bool) else []) +
        (['images'] if (use_images | default(false) | bool) else []) +
        (['alerts'] if (use_alerts | default(false) | bool) else []) +
        (['doi'] if (use_doi | default(false) | bool) else []) +
        (['webapi'] if (use_webapi | default(false) | bool) else []) +
        (['dashboard'] if (use_dashboard | default(false) | bool) else []) +
        (['biocache-backend'] if (use_biocache_backend | default(false) | bool) else []) +
        (['pipelines'] if (use_pipelines | default(false) | bool) else []) +
        (['solrcloud'] if (use_solrcloud | default(false) | bool) else []) +
        (['sds'] if (use_sds | default(false) | bool) else []) +
        (['biocollect'] if (use_biocollect | default(false) | bool) else []) +
        (['namematching'] if (use_namematching_service | default(false) | bool) else []) +
        (['sensitive-data'] if (use_sensitive_data_service | default(false) | bool) else []) +
        (['data-quality'] if (use_data_quality | default(false) | bool) else []) +
        (['events'] if (use_events | default(false) | bool) else []) +
        (['events-elasticsearch'] if (use_events_elasticsearch | default(false) | bool) else []) +
        (['gatus'] if (use_gatus | default(false) | bool) else []))
        | unique
      }}

- name: Debug services_enabled
  debug:
    msg: "Services enabled: {{ services_enabled }}"

- name: Debug individual use_* variables
  debug:
    msg: |
      use_cas = {{ use_cas | default(false) }}
      use_oidc = {{ use_oidc | default(false) }}
      use_collectory = {{ use_collectory | default(false) }}
      use_ala_bie = {{ use_ala_bie | default(false) }}
      use_spatial = {{ use_spatial | default(false) }}

- name: Debug services_enabled list
  debug:
    msg: "{{ services_enabled | to_nice_yaml }}"

- name: Verify cas in services_enabled
  debug:
    msg: "'cas' in services_enabled = {{ 'cas' in services_enabled }}"

- name: Verify userdetails in services_enabled
  debug:
    msg: "'userdetails' in services_enabled = {{ 'userdetails' in services_enabled }}"

- name: Assert cas should be in services_enabled if use_cas is true
  assert:
    that:
      - "'cas' in services_enabled or not (use_cas | default(false) | bool)"
    fail_msg: "ERROR: cas should be in services_enabled when use_cas=true. Got: {{ services_enabled }}"

- name: Run cas configuration generation
  include_role:
    name: cas5
  vars:
    deployment_type: container
  when: "'cas' in services_enabled"
  tags:
    - cas
    - config

- name: Run userdetails configuration generation
  include_role:
    name: userdetails
  vars:
    deployment_type: container
  when: "'userdetails' in services_enabled"
  tags:
    - userdetails
    - config

- name: Run apikey configuration generation
  include_role:
    name: apikey
  vars:
    deployment_type: container
  when: "'apikey' in services_enabled"
  tags:
    - apikey
    - config

- name: Run cas-management configuration generation
  include_role:
    name: cas-management
  vars:
    deployment_type: container
  when: "'cas-management' in services_enabled"
  tags:
    - cas-management
    - config

- name: Load collectory role variables if needed
  include_vars:
    file: "{{ playbook_dir }}/roles/collectory/vars/main.yml"

# Ensure database password variables have values (from inventory or defaults)
# These are critical for docker-compose .env generation
- name: Ensure database password variables are set
  set_fact:
    mysql_root_password: "{{ mysql_root_password | default('generated_mysql_password') }}"
    collectory_db_password: "{{ collectory_db_password | default('generated_collectory_password') }}"
    mongodb_root_password: "{{ mongodb_root_password | default('generated_mongodb_password') }}"
    mongodb_root_username: "{{ mongodb_root_username | default('admin') }}"

# Create common directories BEFORE any role tries to use them
- name: Run common directory and config setup
  include_tasks: common.yml

# Now run collectory and other services
- name: Run collectory configuration generation (asset copy, config templates)
  include_role:
    name: collectory
  vars:
    deployment_type: container
  when: "'collectory' in services_enabled"
  tags:
    - collectory
    - config

- name: Ensure database init directories exist with correct permissions
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  loop:
    - "{{ data_dir }}/mysql/init"
    - "{{ data_dir }}/mongodb/init"

- name: Set CAS database variables from inventories for MongoDB initialization
  set_fact:
    cas_tickets_username: "{{ cas_tickets_username | default('cas-ticket-user') }}"
    cas_tickets_password: "{{ cas_tickets_password | default(lookup('password', '/dev/null length=20')) }}"
    cas_tickets_db: "{{ cas_tickets_db | default('cas-ticket-registry') }}"
    cas_services_username: "{{ cas_services_username | default('cas-services-user') }}"
    cas_services_password: "{{ cas_services_password | default(lookup('password', '/dev/null length=20')) }}"
    cas_services_db: "{{ cas_services_db | default('cas-service-registry') }}"
    cas_audit_username: "{{ cas_audit_username | default('cas-audit-user') }}"
    cas_audit_password: "{{ cas_audit_password | default(lookup('password', '/dev/null length=20')) }}"
    cas_audit_db: "{{ cas_audit_db | default('cas-audit-repository') }}"
    cas_spring_session_username: "{{ cas_spring_session_username | default('cas-session-user') }}"
    cas_spring_session_password: "{{ cas_spring_session_password | default(lookup('password', '/dev/null length=20')) }}"
    spring_session_mongo_collection: "{{ spring_session_mongo_collection | default('spring-sessions') }}"
  when: "'cas' in services_enabled"

- name: Generate MongoDB initialization script
  template:
    src: mongodb-init.js.j2
    dest: "{{ data_dir }}/mongodb/init/init-users.js"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: "'cas' in services_enabled"

- name: Generate .env file with database passwords from inventories
  template:
    src: docker-compose.env.j2
    dest: "{{ data_dir }}/.env"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"

- name: Generate docker-compose.yml
  template:
    src: docker-compose/base.yml.j2
    dest: "{{ data_dir }}/docker-compose.yml"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"

- name: Remove old docker-bake.hcl to force regeneration
  file:
    path: "{{ data_dir }}/docker-bake.hcl"
    state: absent
  when: build_images | default(false)

- name: Generate docker-bake.hcl for optimized builds
  template:
    src: docker-bake.hcl.j2
    dest: "{{ data_dir }}/docker-bake.hcl"
    mode: '0644'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: build_images | default(false)

- name: Ensure nginx config directory exists
  file:
    path: "{{ nginx_conf_dir }}"
    state: directory
    mode: '0755'
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_gid }}"
  when: "'nginx' in services_enabled"

- name: Generate nginx configuration
  template:
    src: nginx/default.conf.j2
    dest: "{{ nginx_conf_dir }}/default.conf"
    mode: '0644'
  when: "'nginx' in services_enabled"

# Reuse role tasks for other services
# Each role handles its own configuration generation
- name: Run species-list configuration generation
  include_role:
    name: species-list
  vars:
    deployment_type: container
  when: "'species-lists' in services_enabled"
  tags:
    - species-list
    - config

- name: Run gatus configuration generation
  include_role:
    name: gatus
  vars:
    deployment_type: container
  when: "'gatus' in services_enabled"
  tags:
    - gatus
    - config

- name: Include build-images tasks
  include_tasks: build-images.yml
  when: build_images | default(false)

- name: Display generated compose file location
  debug:
    msg:
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "ğŸ“„ Docker Compose Configuration Generated"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      - "  Location: {{ data_dir }}/"
      - "  Files:"
      - "    - docker-compose.yml"
      - "{% if build_images | default(false) %}    - docker-bake.hcl{% endif %}"
      - "{% if 'nginx' in services_enabled %}    - nginx/default.conf{% endif %}"
      - "{% if 'collectory' in services_enabled %}    - collectory/config/collectory-config.properties{% endif %}"
      - "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

- name: Fix ownership of configuration files (user-relevant files only)
  shell: |
    # Fix docker-compose.yml
    if [ -f "{{ data_dir }}/docker-compose.yml" ]; then
      chown {{ ansible_user_id }}:{{ ansible_user_gid }} "{{ data_dir }}/docker-compose.yml"
    fi
    
    # Fix nginx configuration
    if [ -d "{{ data_dir }}/nginx" ]; then
      chown -R {{ ansible_user_id }}:{{ ansible_user_gid }} "{{ data_dir }}/nginx"
      find "{{ data_dir }}/nginx" -type d -exec chmod 0755 {} \;
      find "{{ data_dir }}/nginx" -type f -exec chmod 0644 {} \;
    fi
  changed_when: false
  become: yes
