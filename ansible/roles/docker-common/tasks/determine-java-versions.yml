---
# Task to determine Java version for each service based on dependencies.yaml
# This keeps the Docker builds in sync with ALA requirements

- name: Download ALA dependencies from LA Toolkit dependencies.yaml
  uri:
    url: https://raw.githubusercontent.com/living-atlases/la-toolkit-backend/master/assets/dependencies.yaml
    return_content: yes
  register: la_dependencies_yaml
  delegate_to: localhost
  run_once: true

- name: Parse dependencies.yaml
  set_fact:
    la_dependencies: "{{ la_dependencies_yaml.content | from_yaml }}"
  delegate_to: localhost
  run_once: true

- name: Determine Java version for each service using dependencies.yaml
  set_fact:
    collectory_java_version: "{{ 'collectory' | determine_java_version(collectory_version | default('develop'), la_dependencies) }}"
    species_list_java_version: "{{ 'species-lists' | determine_java_version(species_list_version | default('develop'), la_dependencies) }}"
    cas_java_version: "{{ 'cas' | determine_java_version(cas_version | default('develop'), la_dependencies) }}"
    userdetails_java_version: "{{ 'userdetails' | determine_java_version(user_details_version | default('develop'), la_dependencies) }}"
    apikey_java_version: "{{ 'apikey' | determine_java_version(apikey_version | default('develop'), la_dependencies) }}"
    cas_management_java_version: "{{ 'cas-management' | determine_java_version(cas_management_version | default('develop'), la_dependencies) }}"
    ala_bie_java_version: "{{ 'ala-bie' | determine_java_version(bie_hub_version | default('develop'), la_dependencies) }}"
    spatial_java_version: "{{ 'spatial' | determine_java_version(spatial_hub_version | default('develop'), la_dependencies) }}"
    regions_java_version: "{{ 'regions' | determine_java_version(regions_version | default('develop'), la_dependencies) }}"
    species_java_version: "{{ 'species' | determine_java_version(bie_index_version | default('develop'), la_dependencies) }}"
    images_java_version: "{{ 'images' | determine_java_version(image_service_version | default('develop'), la_dependencies) }}"
    alerts_java_version: "{{ 'alerts' | determine_java_version(alerts_version | default('develop'), la_dependencies) }}"
    doi_java_version: "{{ 'doi' | determine_java_version(doi_service_version | default('develop'), la_dependencies) }}"
    dashboard_java_version: "{{ 'dashboard' | determine_java_version(dashboard_version | default('develop'), la_dependencies) }}"
    sds_java_version: "{{ 'sds' | determine_java_version(sds_version | default('develop'), la_dependencies) }}"
    biocollect_java_version: "{{ 'biocollect' | determine_java_version(biocollect_version | default('develop'), la_dependencies) }}"
    namematching_java_version: "{{ 'namematching' | determine_java_version(ala_namematching_service_version | default('develop'), la_dependencies) }}"
    sensitive_data_java_version: "{{ 'sensitive-data' | determine_java_version(ala_sensitive_data_service_version | default('develop'), la_dependencies) }}"
    data_quality_java_version: "{{ 'data-quality' | determine_java_version(data_quality_filter_service_version | default('develop'), la_dependencies) }}"

- name: Display determined Java versions
  debug:
    msg:
      - "Java versions determined from dependencies.yaml:"
      - "  collectory {{ collectory_version | default('develop') }}: Java {{ collectory_java_version }}"
      - "  species-list {{ species_list_version | default('develop') }}: Java {{ species_list_java_version }}"
      - "  cas {{ cas_version | default('develop') }}: Java {{ cas_java_version }}"
      - "  userdetails {{ user_details_version | default('develop') }}: Java {{ userdetails_java_version }}"
      - "  apikey {{ apikey_version | default('develop') }}: Java {{ apikey_java_version }}"
      - "  cas-management {{ cas_management_version | default('develop') }}: Java {{ cas_management_java_version }}"
      - "  ala-bie {{ bie_hub_version | default('develop') }}: Java {{ ala_bie_java_version }}"
      - "  spatial {{ spatial_hub_version | default('develop') }}: Java {{ spatial_java_version }}"
      - "  regions {{ regions_version | default('develop') }}: Java {{ regions_java_version }}"
      - "  species {{ bie_index_version | default('develop') }}: Java {{ species_java_version }}"
      - "  images {{ image_service_version | default('develop') }}: Java {{ images_java_version }}"
      - "  alerts {{ alerts_version | default('develop') }}: Java {{ alerts_java_version }}"
      - "  doi {{ doi_service_version | default('develop') }}: Java {{ doi_java_version }}"
      - "  dashboard {{ dashboard_version | default('develop') }}: Java {{ dashboard_java_version }}"
      - "  sds {{ sds_version | default('develop') }}: Java {{ sds_java_version }}"
      - "  biocollect {{ biocollect_version | default('develop') }}: Java {{ biocollect_java_version }}"
      - "  namematching {{ ala_namematching_service_version | default('develop') }}: Java {{ namematching_java_version }}"
      - "  sensitive-data {{ ala_sensitive_data_service_version | default('develop') }}: Java {{ sensitive_data_java_version }}"
      - "  data-quality {{ data_quality_filter_service_version | default('develop') }}: Java {{ data_quality_java_version }}"

