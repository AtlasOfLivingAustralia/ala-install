---
# Initialize CAS5 and related databases in Docker Compose containers
# This task:
# 1. Sets expose_db_ports_for_init=true to expose MySQL/PostgreSQL/MongoDB ports temporarily
# 2. Regenerates docker-compose.yml with exposed ports
# 3. Executes Ansible db initialization tasks (cas5-dbs, cas5 admin, cas-management OIDC)
# 4. Resets expose_db_ports_for_init=false to hide ports in final configuration
# 5. Recreates containers with original secure configuration

- name: "Database volumes: Ensure all external named volumes exist"
  include_tasks: ensure-db-volumes.yml
  tags:
    - db-init
    - docker-volumes

- name: "Database initialization: Set flag to expose ports"
  set_fact:
    expose_db_ports_for_init: true
  tags:
    - db-init

- name: "Database initialization: Regenerate docker-compose.yml with exposed ports"
  include_tasks: generate-compose.yml
  tags:
    - db-init

- name: "Database initialization: Start database containers with exposed ports"
  shell: |
    cd "{{ data_dir }}" && docker compose up -d mysql postgres mongodb
  changed_when: false
  tags:
    - db-init

- name: "Database initialization: Wait for databases to be ready"
  wait_for:
    host: 127.0.0.1
    port: "{{ item }}"
    delay: 2
    timeout: 60
  loop:
    - 3306
    - 5432
    - 27017
  tags:
    - db-init

- name: "Database initialization: Initialize CAS5 databases"
  include_tasks: ../../cas5-dbs/tasks/main.yml
  vars:
    # Use container names for Docker Compose - these resolve via network
    cas_db_hostname: "{{ docker_db_mysql_host | default('la_mysql') }}"
    user_store_db_hostname: "{{ docker_db_mysql_host | default('la_mysql') }}"
    apikey_db_hostname: "{{ docker_db_mysql_host | default('la_mysql') }}"
    ticket_registry_db_hostname: "{{ docker_db_postgres_host | default('la_postgres') }}"
    cas_audit_host: "{{ docker_db_mongodb_host | default('la_mongodb') }}"
    cas_spring_session_host: "{{ docker_db_mongodb_host | default('la_mongodb') }}"
    cas_tickets_host: "{{ docker_db_mongodb_host | default('la_mongodb') }}"
    cas_services_host: "{{ docker_db_mongodb_host | default('la_mongodb') }}"
    cas_mysql_src_host: '%'
    apikey_mysql_src_host: '%'
  tags:
    - db-init
    - cas-dbs
  run_once: true

- name: "Database initialization: Initialize CAS5 admin account"
  include_tasks: ../../cas5/tasks/admin-account.yml
  vars:
    cas_db_hostname: "{{ docker_db_mysql_host | default('la_mysql') }}"
  tags:
    - db-init
    - cas-dbs
  run_once: true

- name: "Database initialization: Initialize CAS Management OIDC configuration"
  include_tasks: ../../cas-management/tasks/oidc-tasks.yml
  tags:
    - db-init
    - cas-dbs
    - cas-oidc
  run_once: true

- name: "Database initialization: Validate database initialization"
  include_tasks: validate-db-init.yml
  tags:
    - db-init
    - db-validation
  run_once: true

- name: "Database initialization: Reset flag to hide ports"
  set_fact:
    expose_db_ports_for_init: false
  tags:
    - db-init

- name: "Database initialization: Regenerate docker-compose.yml without exposed ports"
  include_tasks: generate-compose.yml
  tags:
    - db-init

- name: "Database initialization: Restart containers with secure configuration"
  shell: |
    cd "{{ data_dir }}" && docker compose up -d mysql postgres mongodb
  changed_when: false
  tags:
    - db-init

- name: "Database initialization: Verify containers are healthy"
  wait_for:
    host: 127.0.0.1
    port: 3306
    delay: 2
    timeout: 60
  tags:
    - db-init

- name: "Database initialization: Summary"
  debug:
    msg: |
      âœ… Database initialization complete!
      - All databases initialized successfully
      - CAS5 databases, users, and schemas created
      - CAS5 admin account configured
      - CAS Management OIDC configuration applied
      - Temporary exposed ports have been removed
      - Containers running with secure internal network only
  tags:
    - db-init

