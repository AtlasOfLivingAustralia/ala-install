---

- name: ensure target db directories exist
  file: path={{item}} state=directory owner={{nginx_user}} group={{nginx_user}}
  with_items:
    - "{{ data_dir }}/nginx/docker"
  tags:
    - docker-service
    - docker-common

# This is used to communicate between nginx->tomcat,etc
- name: Create la_internal network
  docker_network:
    name: la_internal
    driver: overlay
    state: present
    driver_options:
      # With mtu issues depending on the provider, we should try to adjust this 
      # to a lower value (Sweden advice):
      com.docker.network.driver.mtu: "{{ docker_network_mtu | default(1500) }}"
  become: true
  run_once: true
  tags:
    - docker-service
    - docker-common

# Generate Dockerfiles from templates for enabled services
- name: Create directories for all services
  file:
    path: "{{ docker_output_dir }}/{{ item.key }}"
    state: directory
    mode: '0755'
  loop: "{{ docker_services_config | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  tags:
    - docker-common
  when:
    - item.value.get('source_type', 'java') not in ['debian-package', 'docker-image']

- name: Generate Gradle Dockerfiles
  template:
    src: "Dockerfile.gradle.j2"
    dest: "{{ docker_output_dir }}/{{ item.key }}/Dockerfile"
    mode: '0644'
  loop: "{{ docker_services_config | dict2items | selectattr('value.build_tool', 'equalto', 'gradle') }}"
  loop_control:
    label: "{{ item.key }}"
  vars:
    service_name: "{{ item.key }}"
    description: "{{ item.value.description }}"
    artifact_id: "{{ item.value.artifact_id }}"
    group_id: "{{ item.value.group_id }}"
    java_version: "{{ item.value.java_version }}"
    runtime_image: "{{ item.value.runtime_image }}"
    repo: "{{ item.value.repo }}"
    branch: "{{ item.value.branch }}"
    port: "{{ item.value.port }}"
    classifier: "{{ item.value.classifier }}"
    version_variable: "{{ item.value.version_variable }}"
  tags:
    - docker-common
  when:
    - item.value.get('source_type', 'java') not in ['debian-package', 'docker-image']

- name: Generate Maven Dockerfiles
  template:
    src: "Dockerfile.maven.j2"
    dest: "{{ docker_output_dir }}/{{ item.key }}/Dockerfile"
    mode: '0644'
  loop: "{{ docker_services_config | dict2items | selectattr('value.build_tool', 'equalto', 'maven') }}"
  loop_control:
    label: "{{ item.key }}"
  vars:
    service_name: "{{ item.key }}"
    description: "{{ item.value.description }}"
    artifact_id: "{{ item.value.artifact_id }}"
    group_id: "{{ item.value.group_id }}"
    java_version: "{{ item.value.java_version }}"
    runtime_image: "{{ item.value.runtime_image }}"
    repo: "{{ item.value.repo }}"
    branch: "{{ item.value.branch }}"
    port: "{{ item.value.port }}"
    classifier: "{{ item.value.classifier }}"
    version_variable: "{{ item.value.version_variable }}"
  tags:
    - docker-common
  when:
    - item.value.get('source_type', 'java') not in ['debian-package', 'docker-image']

- name: Display generated Dockerfiles
  debug:
    msg: |
      âœ… Generated Dockerfiles:
      {% for service_name, service_config in docker_services_config.items() %}
      {% if service_config.get('source_type', 'java') not in ['debian-package', 'docker-image'] %}
      - {{ service_name }}/Dockerfile ({{ service_config.build_tool | default('gradle') }})
      {% endif %}
      {% endfor %}
  tags:
    - docker-common

- name: Include common tasks to others roles
  include_tasks: common.yml
  tags:
    - docker-common

- name: Deploy common services stack
  import_tasks: ../../docker-common/tasks/stack-create.yml
  vars:
    stack: la_common
    docker_compose_data_dir: "{{ nginx_data_dir }}/docker/"
