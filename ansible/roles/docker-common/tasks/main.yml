---

- name: ensure target db directories exist
  file: path={{item}} state=directory owner={{nginx_user}} group={{nginx_user}}
  with_items:
    - "{{ data_dir }}/nginx/docker"
  tags:
    - docker-service
    - docker-common

# This is used to communicate between nginx->tomcat,etc
- name: Create la-internal network
  docker_network:
    name: la-internal
    driver: overlay
    state: present
    driver_options:
      # With mtu issues depending on the provider, we should try to adjust this 
      # to a lower value (Sweden advice):
      com.docker.network.driver.mtu: "{{ docker_network_mtu | default(1500) }}"
  become: true
  tags:
    - docker-common

- name: Include common tasks to others roles
  include_tasks: common.yml
  tags:
    - docker-common

# Common services (nginx, postfix)
- name: Generate Docker Compose file from template
  template:
    src: docker-compose.yml.j2
    dest: "{{ nginx_data_dir }}/docker/docker-compose.yml"
  tags:
    - docker-service
    - docker-common

- name: Deploy Docker Swarm stack
  docker_stack:
    name: common
    state: present
    compose:
      - "{{ nginx_data_dir }}/docker/docker-compose.yml"
  tags:
    - docker-service
    - docker-common
