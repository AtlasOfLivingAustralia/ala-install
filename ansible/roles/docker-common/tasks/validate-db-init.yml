---
# Validate that databases and tables were created correctly
# This task validates:
# 1. MySQL databases (emmet, apikey) and tables
# 2. MongoDB collections and users
# 3. OIDC keys in MongoDB cas-service-registry

- name: "Database validation: Validate MySQL emmet database and tables"
  shell: |
    mysql -h 127.0.0.1 \
    -u "{{ mysql_root_username }}" \
    -p"{{ mysql_root_password }}" \
    "{{ cas_db_name | default('emmet') }}" \
    -e "SHOW TABLES;" 2>&1
  register: emmet_tables
  failed_when: "'error' in emmet_tables.stderr.lower() or emmet_tables.rc != 0"
  tags:
    - db-init
    - db-validation

- name: "Database validation: Verify emmet database has tables"
  assert:
    that:
      - emmet_tables.stdout_lines | length > 1
    fail_msg: "Emmet database appears to be empty or not initialized properly. Tables found: {{ emmet_tables.stdout_lines }}"
    success_msg: "Emmet database has {{ emmet_tables.stdout_lines | length - 1 }} tables"
  tags:
    - db-init
    - db-validation

- name: "Database validation: Display emmet tables"
  debug:
    msg: |
      ✅ MySQL Emmet database tables:
      {{ emmet_tables.stdout }}
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate MySQL apikey database and tables"
  shell: |
    mysql -h 127.0.0.1 \
    -u "{{ mysql_root_username }}" \
    -p"{{ mysql_root_password }}" \
    "{{ apikey_db_name | default('apikey') }}" \
    -e "SHOW TABLES;" 2>&1
  register: apikey_tables
  failed_when: apikey_tables.rc | int != 0
  tags:
    - db-init
    - db-validation

- name: "Database validation: Verify apikey database has tables"
  assert:
    that:
      - apikey_tables.stdout_lines | length > 1
    fail_msg: "Apikey database appears to be empty or not initialized properly. Tables found: {{ apikey_tables.stdout_lines }}"
    success_msg: "Apikey database has {{ apikey_tables.stdout_lines | length - 1 }} tables"
  tags:
    - db-init
    - db-validation

- name: "Database validation: Display apikey tables"
  debug:
    msg: |
      ✅ MySQL Apikey database tables:
      {{ apikey_tables.stdout }}
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate MongoDB cas-ticket-registry database"
  shell: |
    mongosh --host "{{ cas_tickets_host }}" --port "{{ cas_tickets_port | default('27017') }}" \
    --username "{{ cas_tickets_username }}" --password "{{ cas_tickets_password }}" \
    "{{ cas_tickets_db | default('cas-ticket-registry') }}" \
    --eval "db.getCollectionNames()" --quiet 2>&1 || \
    mongo --host "{{ cas_tickets_host }}" --port "{{ cas_tickets_port | default('27017') }}" \
    --username "{{ cas_tickets_username }}" --password "{{ cas_tickets_password }}" \
    "{{ cas_tickets_db | default('cas-ticket-registry') }}" \
    --eval "db.getCollectionNames()" --quiet 2>&1
  register: ticket_registry_collections
  failed_when: false
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate MongoDB cas-service-registry database"
  shell: |
    mongosh --host "{{ cas_services_host }}" --port "{{ cas_services_port | default('27017') }}" \
    --username "{{ cas_services_username }}" --password "{{ cas_services_password }}" \
    "{{ cas_services_db | default('cas-service-registry') }}" \
    --eval "db.getCollectionNames()" --quiet 2>&1 || \
    mongo --host "{{ cas_services_host }}" --port "{{ cas_services_port | default('27017') }}" \
    --username "{{ cas_services_username }}" --password "{{ cas_services_password }}" \
    "{{ cas_services_db | default('cas-service-registry') }}" \
    --eval "db.getCollectionNames()" --quiet 2>&1
  register: service_registry_collections
  failed_when: false
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate MongoDB cas-audit-repository database"
  shell: |
    mongosh --host "{{ cas_audit_host | default('localhost') }}" --port "{{ cas_audit_port | default('27017') }}" \
    --username "{{ mongodb_root_username }}" --password "{{ mongodb_root_password }}" \
    "{{ cas_audit_db | default('cas-audit-repository') }}" \
    --eval "db.getCollectionNames()" --quiet 2>&1 || \
    mongo --host "{{ cas_audit_host | default('localhost') }}" --port "{{ cas_audit_port | default('27017') }}" \
    --username "{{ mongodb_root_username }}" --password "{{ mongodb_root_password }}" \
    "{{ cas_audit_db | default('cas-audit-repository') }}" \
    --eval "db.getCollectionNames()" --quiet 2>&1
  register: audit_repository_collections
  failed_when: false
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate MongoDB spring-sessions database"
  shell: |
    mongosh --host "{{ cas_spring_session_host | default('localhost') }}" --port "{{ cas_spring_session_port | default('27017') }}" \
    --username "{{ mongodb_root_username }}" --password "{{ mongodb_root_password }}" \
    "{{ spring_session_mongo_collection | default('spring-sessions') }}" \
    --eval "db.getCollectionNames()" --quiet 2>&1 || \
    mongo --host "{{ cas_spring_session_host | default('localhost') }}" --port "{{ cas_spring_session_port | default('27017') }}" \
    --username "{{ mongodb_root_username }}" --password "{{ mongodb_root_password }}" \
    "{{ spring_session_mongo_collection | default('spring-sessions') }}" \
    --eval "db.getCollectionNames()" --quiet 2>&1
  register: spring_session_collections
  failed_when: false
  tags:
    - db-init
    - db-validation

- name: "Database validation: Display MongoDB database validation results"
  debug:
    msg: |
      ✅ MongoDB Databases Validation:
      
      CAS Ticket Registry:
      Collections: {{ ticket_registry_collections.stdout }}
      
      CAS Service Registry:
      Collections: {{ service_registry_collections.stdout }}
      
      CAS Audit Repository:
      Collections: {{ audit_repository_collections.stdout }}
      
      Spring Sessions:
      Collections: {{ spring_session_collections.stdout }}
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate OIDC services in MongoDB"
  shell: |
    mongosh --host "{{ docker_db_mongodb_host | default('la_mongodb') }}" --port "{{ cas_services_port | default('27017') }}" \
    --username "{{ cas_services_username }}" --password "{{ cas_services_password }}" \
    "{{ cas_services_db | default('cas-service-registry') }}" \
    --eval "db.OAuthRegisteredService.countDocuments()" --quiet 2>&1 || \
    mongo --host "{{ docker_db_mongodb_host | default('la_mongodb') }}" --port "{{ cas_services_port | default('27017') }}" \
    --username "{{ cas_services_username }}" --password "{{ cas_services_password }}" \
    "{{ cas_services_db | default('cas-service-registry') }}" \
    --eval "db.OAuthRegisteredService.countDocuments()" --quiet 2>&1
  register: oidc_services_count
  failed_when: false
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate OIDC services list"
  shell: |
    mongosh --host "{{ docker_db_mongodb_host | default('la_mongodb') }}" --port "{{ cas_services_port | default('27017') }}" \
    --username "{{ cas_services_username }}" --password "{{ cas_services_password }}" \
    "{{ cas_services_db | default('cas-service-registry') }}" \
    --eval "db.OAuthRegisteredService.find({}, {name: 1, clientId: 1}).pretty()" --quiet 2>&1 || \
    mongo --host "{{ docker_db_mongodb_host | default('la_mongodb') }}" --port "{{ cas_services_port | default('27017') }}" \
    --username "{{ cas_services_username }}" --password "{{ cas_services_password }}" \
    "{{ cas_services_db | default('cas-service-registry') }}" \
    --eval "db.OAuthRegisteredService.find({}, {name: 1, clientId: 1}).pretty()" --quiet 2>&1
  register: oidc_services_list
  failed_when: false
  tags:
    - db-init
    - db-validation

- name: "Database validation: Display OIDC services"
  debug:
    msg: |
      ✅ OIDC Services Found: {{ oidc_services_count.stdout }}
      
      Registered OIDC Services:
      {{ oidc_services_list.stdout }}
  tags:
    - db-init
    - db-validation

- name: "Database validation: Final summary"
  debug:
    msg: |
      ✅ Database Validation Complete!
      
      Summary:
      ✓ MySQL Emmet database: {{ emmet_tables.stdout_lines | length - 1 }} tables
      ✓ MySQL Apikey database: {{ apikey_tables.stdout_lines | length - 1 }} tables
      ✓ MongoDB CAS Ticket Registry: Initialized
      ✓ MongoDB CAS Service Registry: Initialized with {{ oidc_services_count.stdout }} OIDC services
      ✓ MongoDB CAS Audit Repository: Initialized
      ✓ MongoDB Spring Sessions: Initialized
      
      All database initialization validations passed!
  tags:
    - db-init
    - db-validation
