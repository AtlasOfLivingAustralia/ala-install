---
# Validate that databases and tables were created correctly
# This task validates using native Ansible modules (no shell dependencies)
# 1. MySQL databases (emmet, apikey) and tables
# 2. MongoDB collections
# 3. OIDC services in MongoDB

- name: "Database validation: Validate MySQL emmet database tables"
  community.mysql.mysql_query:
    login_host: "{{ docker_db_mysql_host | default('la_mysql') }}"
    login_user: "{{ mysql_root_username }}"
    login_password: "{{ mysql_root_password }}"
    query: "SHOW TABLES FROM {{ cas_db_name | default('emmet') }}"
  register: emmet_tables
  ignore_errors: yes
  tags:
    - db-init
    - db-validation

- name: "Database validation: Verify emmet database has tables"
  assert:
    that:
      - emmet_tables is not failed
      - emmet_tables.query_result | length > 0
    fail_msg: |
      ❌ FAILED: Emmet database validation failed!
      Error: {{ emmet_tables.msg if emmet_tables is failed else 'No tables found' }}
    success_msg: "✅ OK - Emmet database has {{ emmet_tables.query_result | length }} tables"
  tags:
    - db-init
    - db-validation

- name: "Database validation: Display emmet tables"
  debug:
    msg: |
      ✅ MySQL Emmet database tables ({{ emmet_tables.query_result | length }}):
      {% for table in emmet_tables.query_result %}
      - {{ table.values() | list | first }}
      {% endfor %}
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate MySQL apikey database tables"
  community.mysql.mysql_query:
    login_host: "{{ docker_db_mysql_host | default('la_mysql') }}"
    login_user: "{{ mysql_root_username }}"
    login_password: "{{ mysql_root_password }}"
    query: "SHOW TABLES FROM {{ apikey_db_name | default('apikey') }}"
  register: apikey_tables
  ignore_errors: yes
  tags:
    - db-init
    - db-validation

- name: "Database validation: Verify apikey database has tables"
  assert:
    that:
      - apikey_tables is not failed
      - apikey_tables.query_result | length > 0
    fail_msg: |
      ❌ FAILED: Apikey database validation failed!
      Error: {{ apikey_tables.msg if apikey_tables is failed else 'No tables found' }}
    success_msg: "✅ OK - Apikey database has {{ apikey_tables.query_result | length }} tables"
  tags:
    - db-init
    - db-validation

- name: "Database validation: Display apikey tables"
  debug:
    msg: |
      ✅ MySQL Apikey database tables ({{ apikey_tables.query_result | length }}):
      {% for table in apikey_tables.query_result %}
      - {{ table.values() | list | first }}
      {% endfor %}
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate MongoDB cas-ticket-registry collections"
  community.mongodb.mongodb_info:
    login_host: "{{ docker_db_mongodb_host | default('la_mongodb') }}"
    login_port: "{{ cas_tickets_port | default(27017) }}"
    login_user: "{{ cas_tickets_username }}"
    login_password: "{{ cas_tickets_password }}"
    filter:
      - collections
  register: ticket_registry_info
  ignore_errors: yes
  tags:
    - db-init
    - db-validation

- name: "Database validation: Verify MongoDB cas-ticket-registry has collections"
  assert:
    that:
      - ticket_registry_info is not failed
      - ticket_registry_info.msg is defined or ticket_registry_info.databases is defined
    fail_msg: |
      ❌ FAILED: MongoDB cas-ticket-registry validation failed!
      Error: {{ ticket_registry_info.msg if ticket_registry_info.msg is defined else 'Unable to retrieve collections' }}
    success_msg: "✅ OK - MongoDB CAS Ticket Registry is initialized"
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate MongoDB cas-service-registry collections"
  community.mongodb.mongodb_info:
    login_host: "{{ docker_db_mongodb_host | default('la_mongodb') }}"
    login_port: "{{ cas_services_port | default(27017) }}"
    login_user: "{{ cas_services_username }}"
    login_password: "{{ cas_services_password }}"
    filter:
      - collections
  register: service_registry_info
  ignore_errors: yes
  tags:
    - db-init
    - db-validation

- name: "Database validation: Verify MongoDB cas-service-registry has collections"
  assert:
    that:
      - service_registry_info is not failed
      - service_registry_info.msg is defined or service_registry_info.databases is defined
    fail_msg: |
      ❌ FAILED: MongoDB cas-service-registry validation failed!
      Error: {{ service_registry_info.msg if service_registry_info.msg is defined else 'Unable to retrieve collections' }}
    success_msg: "✅ OK - MongoDB CAS Service Registry is initialized"
  tags:
    - db-init
    - db-validation

- name: "Database validation: Check OIDC services count (MongoDB)"
  community.mongodb.mongodb_query:
    login_host: "{{ docker_db_mongodb_host | default('la_mongodb') }}"
    login_port: "{{ cas_services_port | default(27017) }}"
    login_user: "{{ cas_services_username }}"
    login_password: "{{ cas_services_password }}"
    database: "{{ cas_services_db | default('cas-service-registry') }}"
    collection: "OAuthRegisteredService"
    find: {}
  register: oidc_services
  ignore_errors: yes
  tags:
    - db-init
    - db-validation

- name: "Database validation: Verify OIDC services are registered"
  assert:
    that:
      - oidc_services is not failed
      - oidc_services.result | length >= 1
    fail_msg: |
      ❌ FAILED: OIDC services validation failed!
      Error: {{ oidc_services.msg if oidc_services is failed else 'No OIDC services found' }}
      Services found: {{ oidc_services.result | length | default(0) }}
    success_msg: "✅ OK - OIDC services registered: {{ oidc_services.result | length }}"
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate MongoDB cas-audit-repository collections"
  community.mongodb.mongodb_info:
    login_host: "{{ docker_db_mongodb_host | default('la_mongodb') }}"
    login_port: "{{ cas_audit_port | default(27017) }}"
    login_user: "{{ mongodb_root_username }}"
    login_password: "{{ mongodb_root_password }}"
    filter:
      - collections
  register: audit_repository_info
  ignore_errors: yes
  tags:
    - db-init
    - db-validation

- name: "Database validation: Verify MongoDB cas-audit-repository has collections"
  assert:
    that:
      - audit_repository_info is not failed
      - audit_repository_info.msg is defined or audit_repository_info.databases is defined
    fail_msg: |
      ❌ FAILED: MongoDB cas-audit-repository validation failed!
      Error: {{ audit_repository_info.msg if audit_repository_info.msg is defined else 'Unable to retrieve collections' }}
    success_msg: "✅ OK - MongoDB CAS Audit Repository is initialized"
  tags:
    - db-init
    - db-validation

- name: "Database validation: Validate MongoDB spring-sessions collections"
  community.mongodb.mongodb_info:
    login_host: "{{ docker_db_mongodb_host | default('la_mongodb') }}"
    login_port: "{{ cas_spring_session_port | default(27017) }}"
    login_user: "{{ mongodb_root_username }}"
    login_password: "{{ mongodb_root_password }}"
    filter:
      - collections
  register: spring_session_info
  ignore_errors: yes
  tags:
    - db-init
    - db-validation

- name: "Database validation: Verify MongoDB spring-sessions has collections"
  assert:
    that:
      - spring_session_info is not failed
      - spring_session_info.msg is defined or spring_session_info.databases is defined
    fail_msg: |
      ❌ FAILED: MongoDB spring-sessions validation failed!
      Error: {{ spring_session_info.msg if spring_session_info.msg is defined else 'Unable to retrieve collections' }}
    success_msg: "✅ OK - MongoDB Spring Sessions is initialized"
  tags:
    - db-init
    - db-validation

- name: "Database validation: Final summary"
  debug:
    msg: |
      ✅ Database Validation Complete!
      
      Summary:
      ✓ MySQL Emmet database: {{ emmet_tables.query_result | length }} tables
      ✓ MySQL Apikey database: {{ apikey_tables.query_result | length }} tables
      ✓ MongoDB CAS Ticket Registry: Initialized
      ✓ MongoDB CAS Service Registry: Initialized with {{ oidc_services.result | length }} OIDC services
      ✓ MongoDB CAS Audit Repository: Initialized
      ✓ MongoDB Spring Sessions: Initialized
      
      All database initialization validations passed!
  tags:
    - db-init
    - db-validation
