---
version: '3.8'

services:

  nginx:
    image: {{ docker_web_image }}
    ports:
      - "{{ docker_web_port }}:80"
    volumes:
      - nginx-config:/etc/nginx/conf.d
      - nginx-available:/etc/nginx/sites-available
      - nginx-enabled:/etc/nginx/sites-enabled
      - etc-certs:/etc/certs
    networks:
      - external-network
      - internal-network:
        aliases: "{{ nginx_docker_internal_aliases | join('\n          - ') }}"
          # This should generate something like this:
          # - collectory.l-a.site
          # - biocache.l-a.site
          # so other images will reach these hosts internally

  postfix:
    image: boky/postfix
    ports:
      - 25
    environment:
      HOSTNAME: {{ email_hostname | default('') }}
      RELAYHOST: {{ email_sender_server | default('') }}
      RELAYHOST_USERNAME: {{ email_sender | default('') }}
      RELAYHOST_PASSWORD: {{ email_sender_password | default('') }}
      ALLOWED_SENDER_DOMAINS: {{ email_allowed_domains | default('') }}

networks:

  internal-network:
    driver: overlay
  external-network:
    driver: overlay
    external: true

volumes:

  nginx-config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: {{ data_dir }}/nginx/conf.d

  nginx-available:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: {{ data_dir }}/nginx/sites-available

  nginx-enabled:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: {{ data_dir }}/nginx/sites-enabled

  etc-certs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /etc/certs
