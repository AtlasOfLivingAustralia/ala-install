---
version: '3.8'

# Load environment variables from .env file
# This allows passwords and sensitive data to be stored separately from docker-compose.yml
env_file:
  - .env

services:

  nginx:
    image: {{ docker_web_image }}
    # Run in all the hosts
    deploy:
      mode: global
    ports:
      - "{{ docker_http_port }}:80"
      - "{{ docker_https_port }}:443"
    volumes:
      - nginx-config:/etc/nginx/conf.d
      - nginx-available:/etc/nginx/sites-available
      - nginx-enabled:/etc/nginx/sites-enabled
{% if use_letsencrypt is defined and use_letsencrypt | bool %}
      - certs:/etc/letsencrypt
{% endif %}
    environment:
      TZ: {{ server_tz }}
    networks:
      la_internal:
        aliases:
          - {{ nginx_docker_internal_aliases | join('\n          - ') }}
          # This should generate something like this:
          # - collectory.l-a.site
          # - biocache.l-a.site
          # so other images will reach these hosts internally

  postfix:
    image: boky/postfix
    ports:
      - 25
    environment:
      TZ: {{ server_tz }}
      HOSTNAME: ${EMAIL_HOSTNAME}
      RELAYHOST: ${EMAIL_SENDER_SERVER}
      RELAYHOST_USERNAME: ${EMAIL_SENDER}
      RELAYHOST_PASSWORD: ${EMAIL_SENDER_PASSWORD}
      ALLOWED_SENDER_DOMAINS: ${EMAIL_ALLOWED_DOMAINS}
    networks:
      la_internal:

networks:
  la_internal:
    external: true

volumes:

  nginx-config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: {{ data_dir }}/nginx/conf.d

  nginx-available:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: {{ data_dir }}/nginx/sites-available

  nginx-enabled:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: {{ data_dir }}/nginx/sites-enabled

{% if use_letsencrypt is defined and use_letsencrypt | bool %}
  certs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /data/letsencrypt
{% endif %}
