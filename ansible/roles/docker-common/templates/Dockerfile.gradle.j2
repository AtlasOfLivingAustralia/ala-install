# syntax=docker/dockerfile:1.4
# {{ service_name }} - {{ description }}
# AUTO-GENERATED - DO NOT EDIT MANUALLY
# Edit docker-common/defaults/main.yml and re-run ansible

ARG GRADLE_BUILDER_IMAGE=gradle-builder:jdk{{ java_version }}
ARG RUNTIME_IMAGE={{ runtime_image }}

# ============================================
# Stage 1: Build (try Nexus first, then source)
# ============================================
FROM ${GRADLE_BUILDER_IMAGE} AS builder

ARG VERSION={{ version }}
ARG REPO={{ repo }}
ARG BRANCH={{ branch }}
ARG ARTIFACT={{ artifact_id }}
ARG GROUP_ID={{ group_id }}
{% if classifier -%}
ARG CLASSIFIER={{ classifier }}
{% endif -%}
# Format: https://nexus.ala.org.au/repository/releases/au/org/ala/{artifact}/{version}/{artifact}-{version}{classifier}.war

WORKDIR /build

# Try Nexus first (if version is release tag), fail if not found
RUN echo "üîç Checking Nexus for ${ARTIFACT} ${VERSION}..." && \
    if [ "${VERSION}" != "develop" ] && [ "${VERSION}" != "master" ]; then \
        {% if classifier -%}
        NEXUS_URL="https://nexus.ala.org.au/repository/releases/au/org/ala/${ARTIFACT}/${VERSION}/${ARTIFACT}-${VERSION}-${CLASSIFIER}.war" && \
        {% else -%}
        NEXUS_URL="https://nexus.ala.org.au/repository/releases/au/org/ala/${ARTIFACT}/${VERSION}/${ARTIFACT}-${VERSION}.war" && \
        {% endif -%}
        echo "   üì• Trying: ${NEXUS_URL}" && \
        if curl -f -L -o artifact.war "${NEXUS_URL}"; then \
            echo "‚úÖ Downloaded from Nexus"; \
        else \
            echo "‚ùå ERROR: Artifact not found in Nexus at ${NEXUS_URL}"; \
            echo "    Please verify:"; \
            echo "    1. ARTIFACT=${ARTIFACT} is correct"; \
            echo "    2. VERSION=${VERSION} exists in Nexus"; \
            echo "    3. CLASSIFIER=${CLASSIFIER} is correct (if applicable)"; \
            exit 1; \
        fi; \
    else \
        git clone ${REPO} . && \
        git checkout ${BRANCH} && \
        ./gradlew clean war -x test --no-daemon --max-workers=1 && \
        mv build/libs/*.war artifact.war; \
    fi

# ============================================
# Stage 2: Runtime
# ============================================
FROM {{ runtime_image }}

LABEL org.opencontainers.image.title="{{ service_name }}"
LABEL org.opencontainers.image.description="{{ description }}"
LABEL org.opencontainers.image.source="{{ repo }}"

# Install dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        curl \
        netcat-traditional \
    && rm -rf /var/lib/apt/lists/*

# Setup
RUN rm -rf /usr/local/tomcat/webapps/*

COPY --from=builder /build/artifact.war /usr/local/tomcat/webapps/{{ service_name }}.war

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=90s --retries=5 \
    CMD curl -f http://localhost:{{ port }}/{{ service_name }}/actuator/health || exit 1

EXPOSE {{ port }}

CMD ["catalina.sh", "run"]

