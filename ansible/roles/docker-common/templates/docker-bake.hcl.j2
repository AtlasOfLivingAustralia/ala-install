# Docker Bake configuration for Living Atlas services
# Generated by ala-install ansible templates
# Based on INBO pattern but adapted for generic LA portals

variable "TAG" {
  default = "{{ docker_tag | default('develop') }}"
}

variable "CACHE_TAG" {
  default = "{{ docker_cache_tag | default('buildcache') }}"
}

variable "DOCKER_REPO" {
  default = "{{ docker_registry | default('') }}"
}

# ============================================
# Builder Base Images (INBO pattern)
# ============================================

# Gradle builder for JDK 11 services (for Gradle 5.x compatibility - collectory, species-list)
target "gradle-builder-jdk11" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/gradle"
  args = {
    JDK_VERSION = "11"
    GRADLE_VERSION = "7"
  }
  tags = ["gradle-builder:jdk11"]
{% if docker_registry and docker_registry != '' %}
  cache-from = ["type=registry,ref={{ docker_registry }}/gradle-builder:jdk11-${CACHE_TAG}"]
{% endif %}
  cache-to = ["type=inline"]
}

# Gradle builder for JDK 17 services (default for all current ALA services)
target "gradle-builder-jdk17" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/gradle"
  args = {
    JDK_VERSION = "17"
    GRADLE_VERSION = "7"
  }
  tags = ["gradle-builder:jdk17so"]
{% if docker_registry and docker_registry != '' %}
  cache-from = ["type=registry,ref={{ docker_registry }}/gradle-builder:jdk17-${CACHE_TAG}"]
{% endif %}
  cache-to = ["type=inline"]
}

# Gradle builder for JDK 21 services (future-proofing)
target "gradle-builder-jdk21" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/gradle"
  args = {
    JDK_VERSION = "21"
    GRADLE_VERSION = "8"
  }
  tags = ["gradle-builder:jdk21"]
{% if docker_registry and docker_registry != '' %}
  cache-from = ["type=registry,ref={{ docker_registry }}/gradle-builder:jdk21-${CACHE_TAG}"]
{% endif %}
  cache-to = ["type=inline"]
}

# ============================================
# Service Targets
# ============================================

{% if i18n.enabled %}
target "i18n" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/i18n"
  args = {}
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/ala-i18n:${TAG}", "{{ docker_registry }}/ala-i18n:latest"]
{% else %}
  tags = ["ala-i18n:${TAG}", "ala-i18n:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'collectory' in services_enabled %}
{% endif %}

{% if 'collectory' in services_enabled %}
target "collectory" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/collectory"
  contexts = {
    "gradle-builder:jdk{{ collectory_java_version | default('17') }}" = "target:gradle-builder-jdk{{ collectory_java_version | default('17') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ collectory_java_version | default('17') }}"
    COLLECTORY_VERSION = "{{ collectory_version | default('develop') }}"
    COLLECTORY_REPO = "https://github.com/AtlasOfLivingAustralia/collectory.git"
    COLLECTORY_BRANCH = "{{ collectory_branch | default('develop') }}"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/collectory:${TAG}", "{{ docker_registry }}/collectory:latest"]
  cache-from = [
    "type=registry,ref={{ docker_registry }}/collectory:${CACHE_TAG}",
    "type=registry,ref={{ docker_registry }}/collectory:latest"
  ]
{% else %}
  tags = ["collectory:${TAG}", "collectory:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

# CAS, UserDetails, APIKey and CAS Management services - built locally
# Builds from ala-cas-5, userdetails, apikey and ala-cas-5-services repositories

{% if 'cas' in services_enabled %}
target "cas" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/cas"
  contexts = {
    "gradle-builder:jdk{{ cas_java_version | default('11') }}" = "target:gradle-builder-jdk{{ cas_java_version | default('11') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ cas_java_version | default('11') }}"
    CAS_VERSION = "{{ cas_version | default('develop') }}"
    CAS_REPO = "https://github.com/AtlasOfLivingAustralia/ala-cas-5.git"
    CAS_BRANCH = "{{ cas_branch | default('master') }}"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/cas:${TAG}", "{{ docker_registry }}/cas:latest"]
{% else %}
  tags = ["cas:${TAG}", "cas:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'userdetails' in services_enabled %}
target "userdetails" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/userdetails"
  contexts = {
    "gradle-builder:jdk{{ userdetails_java_version | default('11') }}" = "target:gradle-builder-jdk{{ userdetails_java_version | default('11') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ userdetails_java_version | default('11') }}"
    USERDETAILS_VERSION = "{{ user_details_version | default('develop') }}"
    USERDETAILS_REPO = "https://github.com/AtlasOfLivingAustralia/userdetails.git"
    USERDETAILS_BRANCH = "{{ user_details_branch | default('master') }}"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/userdetails:${TAG}", "{{ docker_registry }}/userdetails:latest"]
{% else %}
  tags = ["userdetails:${TAG}", "userdetails:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'apikey' in services_enabled %}
target "apikey" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/apikey"
  contexts = {
    "gradle-builder:jdk{{ apikey_java_version | default('11') }}" = "target:gradle-builder-jdk{{ apikey_java_version | default('11') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ apikey_java_version | default('11') }}"
    APIKEY_VERSION = "{{ apikey_version | default('develop') }}"
    APIKEY_REPO = "https://github.com/AtlasOfLivingAustralia/apikey.git"
    APIKEY_BRANCH = "{{ apikey_branch | default('master') }}"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/apikey:${TAG}", "{{ docker_registry }}/apikey:latest"]
{% else %}
  tags = ["apikey:${TAG}", "apikey:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'cas-management' in services_enabled %}
target "cas-management" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/cas-management"
  contexts = {
    "gradle-builder:jdk{{ cas_management_java_version | default('11') }}" = "target:gradle-builder-jdk{{ cas_management_java_version | default('11') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ cas_management_java_version | default('11') }}"
    CAS_MANAGEMENT_VERSION = "{{ cas_management_version | default('develop') }}"
    CAS_MANAGEMENT_REPO = "https://github.com/AtlasOfLivingAustralia/ala-cas-5-services.git"
    CAS_MANAGEMENT_BRANCH = "{{ cas_management_branch | default('master') }}"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/cas-management:${TAG}", "{{ docker_registry }}/cas-management:latest"]
{% else %}
  tags = ["cas-management:${TAG}", "cas-management:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'gatus' in services_enabled %}
target "gatus" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/gatus"
  args = {}
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/gatus:${TAG}", "{{ docker_registry }}/gatus:latest"]
{% else %}
  tags = ["gatus:${TAG}", "gatus:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'species-list' in services_enabled or groups['species-list'] is defined %}
target "species-list" {
  dockerfile = "Dockerfile"
  context = "{{ playbook_dir }}/../docker/species-list"
  contexts = {
    "gradle-builder:jdk{{ species_list_java_version | default('17') }}" = "target:gradle-builder-jdk{{ species_list_java_version | default('17') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ species_list_java_version | default('17') }}"
    SPECIES_LIST_VERSION = "{{ species_list_version | default('develop') }}"
    SPECIES_LIST_REPO = "https://github.com/AtlasOfLivingAustralia/specieslist-webapp.git"
    SPECIES_LIST_BRANCH = "{{ species_list_branch | default('master') }}"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/species-list:${TAG}", "{{ docker_registry }}/species-list:latest"]
{% else %}
  tags = ["species-list:${TAG}", "species-list:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

# ============================================
# Build Groups
# ============================================

# Build builders first
group "builders" {
  targets = [
    "gradle-builder-jdk17",
    "gradle-builder-jdk21",
  ]
}

# Build all services (depends on builders)
group "all" {
  targets = [
{% if i18n.enabled %}
    "i18n",
{% endif %}
{% if 'collectory' in services_enabled %}
    "collectory",
{% endif %}
{% if 'species-list' in services_enabled or groups['species-list'] is defined %}
    "species-list",
{% endif %}
{% if 'cas' in services_enabled %}
    "cas",
{% endif %}
{% if 'userdetails' in services_enabled %}
    "userdetails",
{% endif %}
{% if 'apikey' in services_enabled %}
    "apikey",
{% endif %}
{% if 'cas-management' in services_enabled %}
    "cas-management",
{% endif %}
{% if 'gatus' in services_enabled %}
    "gatus",
{% endif %}
  ]
}

# Build only services (assumes builders exist)
# Note: i18n is built separately with build-i18n-image.sh
group "services" {
  targets = [
{% if 'collectory' in services_enabled %}
    "collectory",
{% endif %}
{% if 'species-list' in services_enabled or groups['species-list'] is defined %}
    "species-list",
{% endif %}
{% if 'cas' in services_enabled %}
    "cas",
{% endif %}
{% if 'userdetails' in services_enabled %}
    "userdetails",
{% endif %}
{% if 'apikey' in services_enabled %}
    "apikey",
{% endif %}
{% if 'cas-management' in services_enabled %}
    "cas-management",
{% endif %}
{% if 'gatus' in services_enabled %}
    "gatus",
{% endif %}
  ]
}
