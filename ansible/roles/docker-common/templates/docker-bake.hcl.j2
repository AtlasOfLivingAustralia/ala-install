# Docker Bake configuration for Living Atlas services
# Generated by ala-install ansible templates
# Based on INBO pattern but adapted for generic LA portals

variable "TAG" {
  default = "{{ docker_tag | default('develop') }}"
}

variable "CACHE_TAG" {
  default = "{{ docker_cache_tag | default('buildcache') }}"
}

variable "DOCKER_REPO" {
  default = "{{ docker_registry | default('') }}"
}

# ============================================
# Builder Base Images (INBO pattern)
# ============================================

# Gradle builder for JDK 11 services (for Gradle 5.x compatibility - collectory, species-list)
target "gradle-builder-jdk11" {
  dockerfile = "Dockerfile"
  context = "../docker/gradle"
  args = {
    JDK_VERSION = "11"
    GRADLE_VERSION = "7"
  }
  # Builders should not have output - they're only used as base images
  # output = ["type=docker"]
{% if docker_registry and docker_registry != '' %}
  cache-from = ["type=registry,ref={{ docker_registry }}/gradle-builder:jdk11-${CACHE_TAG}"]
{% endif %}
  cache-to = ["type=inline"]
}

# Gradle builder for JDK 17 services (default for all current ALA services)
target "gradle-builder-jdk17" {
  dockerfile = "Dockerfile"
  context = "../docker/gradle"
  args = {
    JDK_VERSION = "17"
    GRADLE_VERSION = "7"
  }
  # Builders should not have output - they're only used as base images
  # output = ["type=docker"]
{% if docker_registry and docker_registry != '' %}
  cache-from = ["type=registry,ref={{ docker_registry }}/gradle-builder:jdk17-${CACHE_TAG}"]
{% endif %}
  cache-to = ["type=inline"]
}

# Gradle builder for JDK 21 services (future-proofing)
target "gradle-builder-jdk21" {
  dockerfile = "Dockerfile"
  context = "../docker/gradle"
  args = {
    JDK_VERSION = "21"
    GRADLE_VERSION = "8"
  }
  # Builders should not have output - they're only used as base images
  # output = ["type=docker"]
{% if docker_registry and docker_registry != '' %}
  cache-from = ["type=registry,ref={{ docker_registry }}/gradle-builder:jdk21-${CACHE_TAG}"]
{% endif %}
  cache-to = ["type=inline"]
}

# ============================================
# Service Targets
# ============================================

{% if i18n.enabled %}
target "ala-i18n" {
  dockerfile = "Dockerfile"
  context = "../docker/i18n"
  args = {}
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/ala-i18n:{{ i18n_version }}", "{{ docker_registry }}/ala-i18n:latest"]
{% else %}
  tags = ["ala-i18n:{{ i18n_version }}", "ala-i18n:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'collectory' in services_enabled %}
{% endif %}

{% if 'collectory' in services_enabled %}
target "collectory" {
  dockerfile = "Dockerfile"
  context = "../docker/collectory"
  contexts = {
    "gradle-builder:jdk{{ collectory_java_version | default('17') }}" = "target:gradle-builder-jdk{{ collectory_java_version | default('17') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ collectory_java_version | default('17') }}"
    ARTIFACT = "collectory"
    GROUP_ID = "au.org.ala"
    VERSION = "{{ collectory_version | default('develop') }}"
    REPO = "https://github.com/AtlasOfLivingAustralia/collectory.git"
    BRANCH = "{{ collectory_branch | default('develop') }}"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/collectory:{{ collectory_version | default('latest') }}", "{{ docker_registry }}/collectory:latest"]
  cache-from = [
    "type=registry,ref={{ docker_registry }}/collectory:${CACHE_TAG}",
    "type=registry,ref={{ docker_registry }}/collectory:latest"
  ]
{% else %}
  tags = ["collectory:{{ collectory_version | default('latest') }}", "collectory:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

# CAS, UserDetails, APIKey and CAS Management services

{% if 'userdetails' in services_enabled %}
target "userdetails" {
  dockerfile = "Dockerfile"
  context = "../docker/userdetails"
  contexts = {
    "gradle-builder:jdk{{ userdetails_java_version | default('11') }}" = "target:gradle-builder-jdk{{ userdetails_java_version | default('11') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ userdetails_java_version | default('11') }}"
    ARTIFACT = "userdetails"
    GROUP_ID = "au.org.ala"
    VERSION = "{{ user_details_version | default('develop') }}"
    REPO = "https://github.com/AtlasOfLivingAustralia/userdetails.git"
    BRANCH = "{{ user_details_branch | default('master') }}"
    CLASSIFIER = "exec"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/userdetails:{{ user_details_version | default('latest') }}", "{{ docker_registry }}/userdetails:latest"]
{% else %}
  tags = ["userdetails:{{ user_details_version | default('latest') }}", "userdetails:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'cas' in services_enabled %}
target "cas" {
  dockerfile = "Dockerfile"
  context = "../docker/cas"
  args = {
    MAVEN_BUILDER_IMAGE = "maven:3.8-eclipse-temurin-11"
    RUNTIME_IMAGE = "eclipse-temurin:11-jre-jammy"
    ARTIFACT = "cas"
    GROUP_ID = "au.org.ala"
    VERSION = "{{ cas_version | default('develop') }}"
    REPO = "https://github.com/AtlasOfLivingAustralia/ala-cas-5.git"
    BRANCH = "{{ cas_branch | default('master') }}"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/cas:{{ cas_version | default('latest') }}", "{{ docker_registry }}/cas:latest"]
{% else %}
  tags = ["cas:{{ cas_version | default('latest') }}", "cas:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'apikey' in services_enabled %}
target "apikey" {
  dockerfile = "Dockerfile"
  context = "../docker/apikey"
  contexts = {
    "gradle-builder:jdk{{ apikey_java_version | default('11') }}" = "target:gradle-builder-jdk{{ apikey_java_version | default('11') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ apikey_java_version | default('11') }}"
    ARTIFACT = "apikey"
    GROUP_ID = "au.org.ala"
    VERSION = "{{ apikey_version | default('develop') }}"
    REPO = "https://github.com/AtlasOfLivingAustralia/apikey.git"
    BRANCH = "{{ apikey_branch | default('master') }}"
    CLASSIFIER = "exec"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/apikey:{{ apikey_version | default('latest') }}", "{{ docker_registry }}/apikey:latest"]
{% else %}
  tags = ["apikey:{{ apikey_version | default('latest') }}", "apikey:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'cas-management' in services_enabled %}
target "cas-management" {
  dockerfile = "Dockerfile"
  context = "../docker/cas-management"
  contexts = {
    "gradle-builder:jdk{{ cas_management_java_version | default('11') }}" = "target:gradle-builder-jdk{{ cas_management_java_version | default('11') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ cas_management_java_version | default('11') }}"
    ARTIFACT = "cas-management"
    GROUP_ID = "au.org.ala"
    VERSION = "{{ cas_management_version | default('develop') }}"
    REPO = "https://github.com/AtlasOfLivingAustralia/ala-cas-5-services.git"
    BRANCH = "{{ cas_management_branch | default('master') }}"
    CLASSIFIER = "exec"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/cas-management:{{ cas_management_version | default('latest') }}", "{{ docker_registry }}/cas-management:latest"]
{% else %}
  tags = ["cas-management:{{ cas_management_version | default('latest') }}", "cas-management:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'gatus' in services_enabled %}
target "gatus" {
  dockerfile = "Dockerfile"
  context = "../docker/gatus"
  args = {}
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/gatus:${TAG}", "{{ docker_registry }}/gatus:latest"]
{% else %}
  tags = ["gatus:${TAG}", "gatus:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

{% if 'species-list' in services_enabled or groups['species-list'] is defined %}
target "species-list" {
  dockerfile = "Dockerfile"
  context = "../docker/species-list"
  contexts = {
    "gradle-builder:jdk{{ species_list_java_version | default('17') }}" = "target:gradle-builder-jdk{{ species_list_java_version | default('17') }}"
  }
  args = {
    GRADLE_BUILDER_IMAGE = "gradle-builder:jdk{{ species_list_java_version | default('17') }}"
    VERSION = "{{ species_list_version | default('develop') }}"
    REPO = "https://github.com/AtlasOfLivingAustralia/specieslist-webapp.git"
    BRANCH = "{{ species_list_branch | default('master') }}"
  }
{% if docker_registry and docker_registry != '' %}
  tags = ["{{ docker_registry }}/species-list:{{ species_list_version | default('latest') }}", "{{ docker_registry }}/species-list:latest"]
{% else %}
  tags = ["species-list:{{ species_list_version | default('latest') }}", "species-list:latest"]
{% endif %}
  cache-to = ["type=inline"]
  platforms = ["linux/amd64"]
}
{% endif %}

# ============================================
# Build Groups
# ============================================

# Build builders first
group "builders" {
  targets = [
    "gradle-builder-jdk17",
    "gradle-builder-jdk21",
  ]
}

# Build all services (depends on builders)
group "all" {
  targets = [
{% if i18n.enabled %}
    "ala-i18n",
{% endif %}
{% if 'collectory' in services_enabled %}
    "collectory",
{% endif %}
{% if 'species-list' in services_enabled or groups['species-list'] is defined %}
    "species-list",
{% endif %}
{% if 'cas' in services_enabled %}
    "cas",
{% endif %}
{% if 'userdetails' in services_enabled %}
    "userdetails",
{% endif %}
{% if 'apikey' in services_enabled %}
    "apikey",
{% endif %}
{% if 'cas-management' in services_enabled %}
    "cas-management",
{% endif %}
{% if 'gatus' in services_enabled %}
    "gatus",
{% endif %}
  ]
}

# Build only services (assumes builders exist)
group "services" {
  targets = [
{% if 'collectory' in services_enabled %}
    "collectory",
{% endif %}
{% if 'species-list' in services_enabled or groups['species-list'] is defined %}
    "species-list",
{% endif %}
{% if 'cas' in services_enabled %}
    "cas",
{% endif %}
{% if 'userdetails' in services_enabled %}
    "userdetails",
{% endif %}
{% if 'apikey' in services_enabled %}
    "apikey",
{% endif %}
{% if 'cas-management' in services_enabled %}
    "cas-management",
{% endif %}
{% if 'gatus' in services_enabled %}
    "gatus",
{% endif %}
  ]
}
