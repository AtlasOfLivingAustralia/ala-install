  # CAS Management Service
  cas-management:
    container_name: cas-management
{% if build_images | default(false) %}
    # Using locally built image
    image: cas-management:{{ cas_management_version | default('6.5.5-2') }}
    pull_policy: never
    build:
      context: ../docker/cas-management
      dockerfile: Dockerfile
      args:
        CAS_MANAGEMENT_VERSION: {{ cas_management_version | default('6.5.5-2') }}
        CAS_MANAGEMENT_REPO: {{ cas_management_repo | default('https://github.com/AtlasOfLivingAustralia/ala-cas-5-services.git') }}
        CAS_MANAGEMENT_BRANCH: {{ cas_management_branch | default('master') }}
{% else %}
    # Using locally built image (from docker buildx bake)
    image: cas-management:{{ cas_management_version | default('6.5.5-2') }}
    pull_policy: never
{% endif %}
    volumes:
      - ./cas-management:/data/cas-management
{% if i18n.enabled and i18n.strategy == 'volume' %}
      - {{ i18n.volume.name }}:/opt/atlas/i18n/:ro
{% endif %}
    environment:
      TZ: {{ server_tz | default('UTC') }}
      JAVA_OPTS: ${CAS_MANAGEMENT_JAVA_OPTS}
    ports:
      - "9003:8080"
    networks:
      default: {}
      {{ docker_network | default('la_internal') }}:
        aliases:
          - {{ cas_management_hostname | default(cas_management_docker_host | default('cas-management')) }}
    depends_on:
{% if i18n.enabled and i18n.strategy == 'volume' and i18n.volume.source == 'init-container' %}
      i18n-init:
        condition: service_completed_successfully
{% endif %}
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      cas:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080/cas-management/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    restart: unless-stopped


