  # Collectory service
  collectory:
{% if build_images is defined and (build_images | bool or build_images == 'true') %}
    # Build locally with correct Java version based on collectory_version
    image: {{ docker_registry | default('') }}collectory:{{ docker_tag | default('dev') }}
    pull_policy: never
{% else %}
    # Use Docker Hub image with version from inventory
    image: livingatlases/c nollectory:{{ collectory_version | default('latest') }}
{% endif %}
    volumes:
      - ./collectory/config:/data/collectory/config:ro
      - ./collectory/data:/data/collectory/data
      - collectory-upload:/data/collectory/upload
{% if i18n.enabled and i18n.strategy == 'volume' %}
      - {{ i18n.volume.name }}:/opt/atlas/i18n/:ro
{% elif i18n_package_enabled | default(false) %}
      - /opt/atlas/i18n:/opt/atlas/i18n/:ro
{% endif %}
    environment:
      TZ: {{ server_tz | default('UTC') }}
      DOCKERIZE_OPTS: "-wait tcp://{{ collectory_db_host_address }}:3306 -timeout 120s"
    expose:
      - 8080
    networks:
      default: {}
      {{ docker_network | default('la_internal') }}:
        aliases:
          - {{ collectory_hostname | default(collectory_docker_host | default('collectory')) }}
    depends_on:
{% if i18n.enabled and i18n.strategy == 'volume' and i18n.volume.source == 'init-container' %}
      i18n-init:
        condition: service_completed_successfully
{% endif %}
      mysql:
        condition: service_healthy
{% if 'cas' in services_enabled or groups['cas-servers'] is defined %}
      cas:
        condition: service_healthy
      userdetails:
        condition: service_healthy
      apikey:
        condition: service_healthy
      cas-management:
        condition: service_healthy
{% endif %}
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8080{{ collectory_context_path | default('/collectory') }}/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped


