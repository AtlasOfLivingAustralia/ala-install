---
- name: ensure target db directories exist
  file: path={{item}} state=directory owner={{userdetails_user}} group={{userdetails_user}}
  with_items:
    - "{{ userdetails_docker_db_mysql_data_dir }}"
    - "{{ userdetails_docker_db_mongo_data_dir }}"
    - "{{ userdetails_data_dir }}/docker/"
  tags:
    - docker
    - docker-service

- name: Generate Docker Compose file from template
  template:
    src: docker-compose.yml.j2
    dest: "{{ userdetails_data_dir }}/docker/docker-compose.yml"
  tags:
    - docker
    - docker-service

- name: Generate Docker mysql init file from template
  template:
    src: init-mysql.sql.j2
    dest: "{{ userdetails_data_dir }}/docker/init-mysql.sql"
  tags:
    - docker
    - docker-service

- name: Generate Docker mongo init file from template
  template:
    src: init-mongo.sh.j2
    dest: "{{ userdetails_data_dir }}/docker/init-mongo.sh"
  tags:
    - docker
    - docker-service

- name: Deploy Docker Swarm stack
  docker_stack:
    name: auth
    state: present
    compose:
      - "{{ userdetails_data_dir }}/docker/docker-compose.yml"
  tags:
    - docker
    - docker-service
