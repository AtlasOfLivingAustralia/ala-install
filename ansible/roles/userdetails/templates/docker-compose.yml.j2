---
version: '3.8'

services:

  # ====== DATABASES ======

  mysql:
    image: mysql:5.7
    volumes:
      - mysql_data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: {{ mysql_root_password }}
      TZ: {{ server_tz }}
    expose:
      - 3306
{% if expose_db_ports_for_init | bool %}
    ports:
      - "127.0.0.1:3306:3306"
{% endif %}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p{{ mysql_root_password }}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      default: {}
      la_internal:
        aliases:
          - auth_mysql

  postgres:
    image: postgres:16-alpine
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: {{ postgres_db | default('cas') }}
      POSTGRES_USER: {{ postgres_user | default('postgres') }}
      POSTGRES_PASSWORD: {{ postgresql_password }}
      TZ: {{ server_tz }}
    expose:
      - 5432
{% if expose_db_ports_for_init | bool %}
    ports:
      - "127.0.0.1:5432:5432"
{% endif %}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ postgres_user | default('postgres') }}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      default: {}
      la_internal:
        aliases:
          - auth_postgres

  mongo:
    image: mongo:5
    volumes:
      - mongo_data:/data/db
    command: ["mongod", "--bind_ip_all"]
    environment:
      MONGO_INITDB_ROOT_USERNAME: {{ mongodb_root_username }}
      MONGO_INITDB_ROOT_PASSWORD: {{ mongodb_root_password }}
      TZ: {{ server_tz }}
    expose:
      - 27017
{% if expose_db_ports_for_init | bool %}
    ports:
      - "127.0.0.1:27017:27017"
{% endif %}
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      default: {}
      la_internal:
        aliases:
          - auth_mongo

{% if docker_development_mode is defined and docker_development_mode | bool %}
  mongo-express:
    image: mongo-express
    restart: always
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_SERVER: auth_mongo
      ME_CONFIG_MONGODB_ADMINUSERNAME: {{ mongodb_root_username }}
      ME_CONFIG_MONGODB_ADMINPASSWORD: {{ mongodb_root_password }}
      TZ: {{ server_tz }}
    networks:
      default: {}
      la_internal:
        aliases:
          - auth_mongo_express
{% endif %}

  # ====== DATABASE BACKUPS ======

  db-backup:
    image: tiredofit/db-backup:latest
    container_name: la_auth_db_backup
    volumes:
      - {{ userdetails_data_dir }}/db-backups:/backup
    networks:
      default: {}
      la_internal: {}
    environment:
      - TIMEZONE={{ server_tz }}
      - CONTAINER_NAME=la_auth_db_backup
      - CONTAINER_ENABLE_MONITORING=FALSE
      - DB01_RESOURCE_OPTIMIZED=TRUE
      - BACKUP_JOB_CONCURRENCY=1
      - DEFAULT_CHECKSUM=NONE
      - DEFAULT_COMPRESSION=ZSTD
      - DEFAULT_BACKUP_INTERVAL={{ db_backup_interval | default('1440') }}
      - DEFAULT_BACKUP_BEGIN={{ db_backup_begin | default('0000') }}
      - DEFAULT_CLEANUP_TIME={{ db_cleanup_time | default('8640') }}
      # MongoDB backup (DB01)
      - DB01_TYPE=mongo
      - DB01_HOST=auth_mongo
      - DB01_NAME={{ mongo_backup_db | default('admin') }}
      - DB01_USER={{ mongodb_root_username }}
      - DB01_PASS={{ mongodb_root_password }}
      # MySQL backup (DB02)
      - DB02_TYPE=mysql
      - DB02_HOST=auth_mysql
      - DB02_NAME=all
      - DB02_USER=root
      - DB02_PASS={{ mysql_root_password }}
      # PostgreSQL backup (DB03)
      - DB03_TYPE=postgres
      - DB03_HOST=auth_postgres
      - DB03_NAME=all
      - DB03_USER={{ postgres_user | default('postgres') }}
      - DB03_PASS={{ postgresql_password }}
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      postgres:
        condition: service_healthy
      mongo:
        condition: service_healthy

  # ====== APPLICATIONS ======

  cas:
    image: atlasoflivingaustralia/cas:{{ cas_version }}
    expose:
      - {{ cas_port | default('9000') }}
    environment:
      DOCKERIZE_OPTS: "-wait tcp://auth_mysql:3306 -wait tcp://auth_mongo:27017 -timeout 60s"
      TZ: {{ server_tz }}
    volumes:
      - cas_data:/data/cas
      - logs:/var/log/atlas
{% if i18n_package_enabled | bool %}
      - i18n:/opt/atlas/i18n
      - i18n_custom:/var/opt/atlas/i18n
{% endif %}
    networks:
      default: {}
      la_internal:
        aliases:
          - {{ cas_docker_host }}

  userdetails:
    image: atlasoflivingaustralia/userdetails:{{ user_details_version }}
    expose:
      - {{ userdetails_port | default('9001') }}
    environment:
      DOCKERIZE_OPTS: "-wait tcp://auth_mysql:3306 -wait tcp://auth_cas:{{ cas_port | default('9000') }} -timeout 120s"
      TZ: {{ server_tz }}
    volumes:
      - userdetails_data:/data/userdetails
      - logs:/var/log/atlas
{% if i18n_package_enabled | bool %}
      - i18n:/opt/atlas/i18n
      - i18n_custom:/var/opt/atlas/i18n
{% endif %}
    networks:
      default: {}
      la_internal:
        aliases:
          - {{ userdetails_docker_host }}

  cas-management:
    image: atlasoflivingaustralia/cas-management:{{ cas_management_version }}
    expose:
      - {{ cas_management_port | default('8070') }}
    environment:
      DOCKERIZE_OPTS: "-wait tcp://auth_mysql:3306 -wait tcp://auth_cas:{{ cas_port | default('9000') }} -wait tcp://auth_mongo:27017 -timeout 120s"
      TZ: {{ server_tz }}
    volumes:
      - cas_management_data:/data/cas-management
      - logs:/var/log/atlas
{% if i18n_package_enabled | bool %}
      - i18n:/opt/atlas/i18n
      - i18n_custom:/var/opt/atlas/i18n
{% endif %}
    networks:
      default: {}
      la_internal:
        aliases:
          - {{ cas_management_docker_host }}

networks:
  la_internal:
    external: true
  default:
    driver: overlay
    attachable: true

volumes:

  mysql_data:
    external: true

  pgdata:
    external: true

  mongo_data:
    external: true

  i18n:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /opt/atlas/i18n

  i18n_custom:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/opt/atlas/i18n

  logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/log/atlas

  userdetails_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: {{ userdetails_data_dir }}

  cas_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: {{ cas_data_dir }}

  cas_management_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: {{ cas_management_data_dir }}
