---

- name: Remove legacy NGINX PPA
  become: true
  ansible.builtin.apt_repository:
    repo: ppa:nginx/stable
    state: absent

- name: Remove legacy nginx source list files
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ query('fileglob', '/etc/apt/sources.list.d/*nginx*.list') + query('fileglob', '/etc/apt/sources.list.d/*nginx*.sources') }}"

- name: Remove legacy global APT keys for nginx
  become: true
  ansible.builtin.apt_key:
    id: "{{ item }}"
    state: absent
  loop:
    - ABF5BD827BD9BF62
  ignore_errors: yes

- name: Update APT cache after cleanup
  become: true
  ansible.builtin.apt:
    update_cache: yes

- name: Ensure deps for deb822_repository
  become: true
  ansible.builtin.apt:
    name:
      - python3-debian
      - ca-certificates
    state: present
    update_cache: yes

- name: Add official NGINX repository
  become: true
  ansible.builtin.deb822_repository:
    name: nginx
    types: [deb]
    uris: "http://nginx.org/packages/ubuntu"
    suites: "{{ ansible_facts['distribution_release'] }}"
    components: ["nginx"]
    signed_by: "https://nginx.org/keys/nginx_signing.key"
    state: present
    enabled: true

- name: Update APT cache
  become: true
  ansible.builtin.apt:
    update_cache: yes

- name: Prefer nginx.org packages
  ansible.builtin.copy:
    dest: /etc/apt/preferences.d/99nginx
    mode: '0644'
    content: |
      Package: *
      Pin: origin nginx.org
      Pin: release o=nginx
      Pin-Priority: 900

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: yes

- name: Install NGINX
  become: true
  ansible.builtin.apt:
    name: "{{ nginx_packages | default(['nginx']) }}"
    state: present
    update_cache: yes

- name: Ensure NGINX is running
  become: true
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: yes
